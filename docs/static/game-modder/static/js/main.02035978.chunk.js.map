{"version":3,"sources":["components/simulator.ts","components/SimFrame.tsx","components/Joystick.tsx","components/GameButtons.tsx","components/GamePlayer.tsx","sprite-editor/svgUtil.ts","sprite-editor/svgEvents.ts","sprite-editor/util.ts","sprite-editor/tools.ts","sprite-editor/buttons.ts","sprite-editor/sidebar.ts","sprite-editor/canvasGrid.ts","sprite-editor/bitmap.ts","sprite-editor/canvasState.ts","sprite-editor/spriteEditor.ts","bitmap_helpers.ts","components/TabBar.tsx","telemetry/appinsights.ts","components/GameModder.tsx","App.tsx","components/Share.tsx","index.tsx"],"names":["SimulatorButton","SimFrame","props","className","ref","simulator","setFrame","title","allow","sandbox","Simulator","frame","buttonState","changeListeners","framePromise","readyPromise","lastRunBinary","messageHandler","ev","msg","data","handleMessage","this","window","addEventListener","resolve","button","sendButtonState","cb","indexOf","push","index","splice","binaryjs","waitForSimFrameAsync","then","undefined","id","Math","random","setAttribute","src","waitForSimReadyAsync","sendMessage","type","code","removeEventListener","pressed","updateButtonState","forEach","contentWindow","postMessage","command","runCode","Promise","promise","Deferrable","_resolve","_reject","reject","SVG_WIDTH","HALF_WIDTH","getTouch","identifier","i","changedTouches","length","Joystick","dPadUp","dPadDown","dPadLeft","dPadRight","joystickHandle","joystickAnimation","handleX","handleY","lastOctet","buttonChangeListener","isPressed","Down","updateDirection","Up","Left","Right","refs","bindEvents","addChangeListener","removeChangeListener","changeMode","onClick","xmlns","viewBox","width","height","cx","cy","r","fill","stroke","strokeWidth","x","y","rx","ry","div","PointerEvent","bindPointerEvents","navigator","maxTouchPoints","bindTouchEvents","bindMouseEvents","inGesture","updateJoystickDrag","clientX","clientY","startAnimation","touchIdentifier","touch","preventDefault","bounds","getBoundingClientRect","dx","left","dy","top","angle","atan2","distance","min","sqrt","pow","setHandlePosition","cos","sin","clearButtonPresses","stopAnimation","requestAnimationFrame","animationFrame","getHandleDistance","getHandleAngle","max","cancelAnimationFrame","animation","octet","floor","PI","right","up","down","pressButton","releaseButton","React","Component","GameButtons","sim","PatternUnits","LengthUnit","aButton","aLabel","bButton","bLabel","textAnchor","fontSize","aDistance","bDistance","setButtonState","A","B","isAButton","circle","label","updateButtonGesture","GamePlayer","binJs","isTouchEnabled","hasPointerEvents","BaseElement","el","titleElement","elt","attributes","Object","keys","at","name","value","toString","ns","setAttributeNS","classes","join","split","cls","classList","add","baseVal","addSingleClass","remove","filter","c","removeSingleClass","addClassInternal","removeClassInternal","text","firstChild","insertBefore","appendChild","textContent","visible","DrawContext","Text","Circle","Rect","Line","Polygon","Polyline","Path","Drawable","drawable","draw","g","Group","child","handler","events","e","buttons","SVG","parent","defs","DefsElement","scaleFactor","updateTransform","factor","StyleElement","transform","Pattern","kind","objectBoundingBox","RadialGradient","LinearGradient","ClipPath","css","color","opacity","url","family","size","units","lengthWithUnits","unit","px","radius","corners","x1","y1","x2","y2","from","to","PolyElement","points","map","d","PathContext","toAttribute","update","Gradient","offset","s","fx","fy","fr","document","createElementNS","ops","op","c1x","c1y","c2x","c2y","dc1x","dc1y","dc2x","dc2y","dcx","dcy","xRotate","large","sweepClockwise","args","em","ex","in","cm","mm","pt","pc","percent","MapTools","Bitmask","mask","Uint8Array","ceil","col","row","cellIndex","pointerEvents","move","enter","leave","PaintTool","getPaintToolShortcut","tool","Normal","Rectangle","Fill","Erase","Marquee","Cursor","offsetX","offsetY","Edit","canvasWidth","canvasHeight","toolWidth","startCol","startRow","isStarted","showPreview","state","doEditCore","cursorCol","cursorRow","mergeFloatingLayer","SelectionEdit","endCol","endRow","isDragged","PaintEdit","interpolate","x0","y0","set","xStep","yStep","dErr","abs","err","drawCore","endY","get","image","setPixel","j","OutlineEdit","tl","topLeft","br","bottomRight","drawRectangle","LineEdit","bresenham","CircleEdit","hypot","midpoint","FillEdit","replColor","q","curr","pop","tryPush","MarqueeEdit","isMove","floatingLayer","inFloatingLayer","layerOffsetX","layerOffsetY","copyToLayer","BUTTON_CORNER_RADIUS","BUTTON_BORDER_WIDTH","BUTTON_BOTTOM_BORDER_WIDTH","Button","root","clickHandler","_title","_shortcut","appendClass","removeClass","translate","setRootTitle","disabled","editClass","selected","TextButton","textEl","mkText","moveTo","getComputedTextLength","CursorButton","mkIconButton","icon","drawSingleButton","mkXIconButton","drawLeftButton","lip","border","svg","bg","lineBy","arcBy","close","fg","CursorMultiButton","indexHandler","group","widths","buttonGroup","b","handleClick","cursorIndex","sizeAdjective","getElement","setSelected","UndoRedoGroup","host","undo","redo","setDisabled","drawMidButton","drawRightButton","segments","available","segmentWidth","result","anchor","InputEvent","GestureType","UNDO_REDO_WIDTH","UNDO_REDO_HEIGHT","SideBar","palette","colorSwatches","pencilTool","eraseTool","rectangleTool","fillTool","marqueeTool","sizeGroup","paletteGroup","selectedTool","selectedSwatch","colorPreview","undoRedo","initSizes","initTools","initPalette","updateState","setActiveTool","getButtonForTool","addClass","setActiveColor","SELECTED_BORDER_WIDTH","setToolWidth","scale","onSelected","setCursorSize","initButton","TOOL_BUTTON_WIDTH","setTool","COLOR_PREVIEW_HEIGHT","bgHeight","def","create","clipPathUnits","TOOLBAR_WIDTH","swatch","PALETTE_BORDER_WIDTH","clipPath","setColor","xicon","btn","shortcut","setIconsToDefault","lightModeBackground","CanvasGrid","lightMode","cellWidth","cellHeight","gesture","context","fadeAnimation","selectAnimation","backgroundLayer","paintLayer","overlayLayer","mouseCol","mouseRow","upHandler","endDrag","clientEventToCell","handle","stopPropagation","leaveHandler","Leave","moveHandler","Move","hoverHandler","isHover","createElement","getContext","alpha","fillStyle","hideOverlay","on","clearContext","drawImage","drawFloatingLayer","edit","doEdit","drawCursor","cursor","getCursor","repaint","drawColor","strokeStyle","strokeRect","transparency","fillRect","copy","resizeGrid","kill","showOverlay","stopSelectAnimation","w","h","toastLeft","toastWidth","toastTop","Fade","dead","globalAlpha","font","textBaseline","textAlign","fillText","toastHeight","style","visibility","rowLength","numCells","lockAspectRatio","maxCellWidth","maxCellHeight","aspectRatio","setCellDimensions","initDragSurface","subscribe","Drag","layoutCanvas","drawBackground","start","end","alphaCols","alphaRows","ac","ar","coord","touches","te","clientCoord","scrollX","pageXOffset","scrollY","pageYOffset","drawSelectionAnimation","dashOffset","lineWidth","setLineDash","lineDashOffset","drawLayer","setInterval","clearRect","GestureState","utils","surface","evId","startDrag","canvas","position","clearInterval","lastCol","lastRow","isDown","handlers","event","fire","delay","duration","slope","Date","now","setTimeout","v","Bitmap","buf","coordToIndex","setCore","getCore","sub","change","current","transparent","other","cell","imageLiteralToBitmap","defaultPattern","replace","trim","rows","sprite","spriteWidth","rowValues","spriteHeight","CanvasState","bitmap","res","equals","apply","cut","SpriteEditor","blocksInfo","toolbarRoot","paintSurface","sidebar","header","cachedState","activeTool","undoStack","redoStack","columns","colors","shiftDown","altDown","mouseDown","closeHandler","keyDown","keyCode","shiftAction","discardEdit","setEyedropperMouse","didSomething","updateEdit","pushState","restore","key","switchIconTo","keyUp","clearShiftAction","undoRedoEvent","controlOrMeta","ctrlKey","metaKey","setClass","createDefs","drag","debug","setCell","onEditEnd","rePaint","commit","concat","updateUndoRedo","paintCell","onEditStart","paintEdit","layout","attr","outerHeight","canvasHolder","render","setGridDimensions","paintAreaTop","paintAreaLeft","updateBounds","setPalette","slice","todo","img","resizeBitmap","afterResize","presets","PADDING","ch","updateIcon","setText","removeMouseListeners","showResizeOverlay","gestureEnd","applyEdit","stack","newEdit","writeColor","Outline","define","p","userSpaceOnUse","f4EncodeImg","bpp","getPix","hex2","ptr","shift","pushBits","n","parseColorString","parseInt","substr","_r","_g","_b","defaultPalletColors","toNumbers","bitmapToBinHex","bind","textToBitmap","bmp","bitmapToUrl","cellSize","bitmapToCanvas","toDataURL","createPngImg","updatePngImg","imgData","R","SVG_W","TAB_SVG_H","IMG_SPACE","TabBar","TabBarSvg","TOTAL_IMG_SPACE","LEFT_SPACE","TABS_START","currentTab","tabImages","idx","tabW","tabStart","tabFinish","TAB_MARGIN_T","tabPath","getTabPath","tabImgs","setState","tabChange","href","tickEvent","measures","isLocalHost","appInsights","trackEvent","test","location","getTxtFile","a","xhr","XMLHttpRequest","open","responseType","onload","status","response","Error","send","lastBinary","playTimestamp","moddableImages","CALL_TO_ACTION","GameModder","playBtn","spriteEditorHolder","spriteEditor","imgs","repeat","CreateEmptyImageText","callToAction","default","userImages","currentImg","k","body","getElementsByTagName","wScale","clientWidth","hScale","clientHeight","console","log","currImg","canvases","getElementsByClassName","controls","oldW","getAttribute","oldH","newW","newH","setSizePresets","outerWidth","overflow","addKeyListeners","onClose","onPlay","getImages","ts","imgRegex","match","exec","tabBar","dummyImg","mainTs","galleryHolder","gallerySvg","galleryEnd","galleryEndPath","GAL_SVG_H","m","old","nw","save","load","onTabChange","renderSpriteEditor","renderGallery","modImg","bin","MOD_PREFIX_LEN","BIN_PREFIX_LEN","newHex","oldToFind","oldStartIncl","oldEndExcl","oldHex","gameBinJs","playHandler","Share","role","App","mode","playGame","includeCookie","config","t","arguments","queue","f","u","o","l","parentNode","cookie","version","disableExceptionTracking","instrumentationKey","disableAjaxTracking","overridePageViewDuration","isCookieUseDisabled","isStorageUseDisabled","scrubUrl","addTelemetryInitializer","envelope","telemetryItem","baseData","properties","trackPageView","urlReferrer","referrer","loadAppInsights","ReactDOM","getElementById"],"mappings":"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","file":"static/js/main.02035978.chunk.js","sourcesContent":["export enum SimulatorButton {\n    A,\n    B,\n    Up,\n    Down,\n    Left,\n    Right,\n    Menu,\n    Reset\n}\n\ninterface SimulatorMessage {\n    type: string;\n}\n\ninterface SimulatorReadyMessage extends SimulatorMessage {\n    type: \"ready\";\n}\n\ninterface SimulatorRestartMessage extends SimulatorMessage {\n    type: \"simulator\";\n    command: \"restart\";\n}\n\ninterface SimulatorRunMessage extends SimulatorMessage {\n    type: \"run\";\n    code: string;\n}\n\ninterface SimulatorButtonMessage extends SimulatorMessage {\n    type: \"button-pressed\"\n    button: SimulatorButton;\n    pressed: boolean;\n}\n\ntype SentMessage = SimulatorRunMessage | SimulatorButtonMessage;\ntype ReceivedMessage = SimulatorReadyMessage | SimulatorRestartMessage;\n\n// No trailing slash!!!\nconst baseurl = \"http://localhost:3232\"\n\nexport class Simulator {\n    protected frame: HTMLIFrameElement | undefined;\n    protected buttonState: boolean[] = [];\n\n    protected changeListeners: ((button: SimulatorButton, pressed: boolean) => void)[] = [];\n    protected framePromise: Deferrable;\n    protected readyPromise: Deferrable;\n\n    protected lastRunBinary: string;\n\n    constructor(frame?: HTMLIFrameElement) {\n        this.frame = frame;\n\n        window.addEventListener(\"message\", this.messageHandler);\n    }\n\n    setFrame(frame: HTMLIFrameElement | null) {\n        if (frame) {\n            this.frame = frame;\n            if (this.framePromise) this.framePromise.resolve();\n        }\n    }\n\n    pressButton(button: SimulatorButton) {\n        if (!this.buttonState[button]) {\n            this.sendButtonState(button, true);\n        }\n    }\n\n    releaseButton(button: SimulatorButton) {\n        if (this.buttonState[button]) {\n            this.sendButtonState(button, false);\n        }\n    }\n\n    isPressed(button: SimulatorButton) {\n        return !!this.buttonState[button];\n    }\n\n    addChangeListener(cb: (button: SimulatorButton, pressed: boolean) => void) {\n        if (this.changeListeners.indexOf(cb) === -1) {\n            this.changeListeners.push(cb);\n        }\n    }\n\n    removeChangeListener(cb: (button: SimulatorButton, pressed: boolean) => void) {\n        const index = this.changeListeners.indexOf(cb);\n        if (index !== -1) {\n            this.changeListeners.splice(index, 1);\n        }\n    }\n\n    runCode(binaryjs: string) {\n        this.lastRunBinary = binaryjs;\n\n        this.waitForSimFrameAsync()\n            .then(() => {\n                this.readyPromise = undefined;\n\n                const id = `sim-frame-${Math.random() * 1000000}`;\n                this.frame.setAttribute(\"id\", id);\n                this.frame.src = `${baseurl}/sim/simulator.html?justscreen=1&run=${id}#${id}`;\n\n                this.waitForSimReadyAsync()\n                    .then(() => {\n                        this.sendMessage({\n                            type: \"run\",\n                            code: binaryjs\n                        });\n                    });\n            })\n    }\n\n    dispose() {\n        window.removeEventListener(\"message\", this.messageHandler);\n    }\n\n    protected sendButtonState(button: SimulatorButton, pressed: boolean) {\n        this.updateButtonState(button, pressed);\n        this.sendMessage({\n            type: \"button-pressed\",\n            button,\n            pressed\n        });\n    }\n\n    protected updateButtonState(button: SimulatorButton, pressed: boolean) {\n        if ((!!this.buttonState[button]) !== pressed) {\n            this.buttonState[button] = pressed;\n            this.changeListeners.forEach(cb => cb(button, pressed));\n        }\n    }\n\n    protected sendMessage(msg: SentMessage) {\n        if (this.frame && this.frame.contentWindow) {\n            this.frame.contentWindow.postMessage(msg, \"*\");\n        }\n    }\n\n    protected handleMessage(msg: ReceivedMessage) {\n        switch (msg.type) {\n            case \"ready\":\n                if (this.readyPromise) this.readyPromise.resolve();\n                break;\n            case \"simulator\":\n                if (msg.command === \"restart\") this.runCode(this.lastRunBinary);\n        }\n    }\n\n    protected messageHandler = (ev: MessageEvent) => {\n        const msg = ev.data as ReceivedMessage;\n        this.handleMessage(msg);\n    }\n\n    protected waitForSimFrameAsync() {\n        if (this.frame) return Promise.resolve();\n        if (this.framePromise) return this.framePromise.promise;\n\n        this.framePromise = new Deferrable();\n\n        return this.framePromise.promise;\n    }\n\n    protected waitForSimReadyAsync() {\n        if (this.readyPromise) return this.readyPromise.promise;\n\n        this.readyPromise = new Deferrable();\n\n        return this.readyPromise.promise;\n    }\n}\n\nclass Deferrable {\n    promise: Promise<void>;\n    protected _resolve: () => void;\n    protected _reject: (reason?: any) => void;\n\n    constructor() {\n        this.promise = new Promise((resolve, reject) => {\n            this._resolve = resolve;\n            this._reject = reject;\n        });\n    }\n\n    resolve() {\n        if (this._resolve) this._resolve();\n        this._resolve = undefined;\n        this._reject = undefined;\n    }\n\n    reject() {\n        if (this._reject) this._reject();\n        this._resolve = undefined;\n        this._reject = undefined;\n    }\n\n    isFinished() {\n        return !this._resolve;\n    }\n}","import React from 'react';\nimport \"../css/SimFrame.css\";\nimport { Simulator } from './simulator';\n\n// https://arcade.makecode.com/beta/--run?fullscreen=1&nofooter=1&id=13415-29846-81435-24572\n\nexport interface SimFrameProps {\n    simulator: Simulator;\n}\n\nconst SimFrame: React.FC<SimFrameProps> = props => {\n    return (\n        <div className=\"game-embed\">\n            <iframe ref={ref => props.simulator.setFrame(ref)} className=\"game-embed-frame\" title=\"MakeCode Arcade Simulator\" allow=\"autoplay\" sandbox=\"allow-same-origin allow-scripts\" />\n        </div>\n    );\n}\n\n\nexport default SimFrame;","import React from 'react';\n\nimport { Simulator, SimulatorButton } from \"./simulator\";\n\nimport '../css/Joystick.css';\n\nexport interface JoystickProps {\n    simulator: Simulator;\n    changeMode: (mode: \"play\" | \"share\" | \"mod\") => void;\n}\n\nconst SVG_WIDTH = 40;\nconst HALF_WIDTH = SVG_WIDTH >> 1;\n\nexport class Joystick extends React.Component<JoystickProps, {}> {\n    protected dPadUp: SVGRectElement | undefined;\n    protected dPadDown: SVGRectElement | undefined;\n    protected dPadLeft: SVGRectElement | undefined;\n    protected dPadRight: SVGRectElement | undefined;\n    protected joystickHandle: SVGCircleElement | undefined;\n\n    protected joystickAnimation: number | undefined;\n\n    protected handleX = SVG_WIDTH >> 1;\n    protected handleY = SVG_WIDTH >> 1;\n    protected lastOctet: number | undefined;\n\n    componentDidMount() {\n        this.dPadUp = this.refs[\"dpad-up\"] as SVGRectElement;\n        this.dPadDown = this.refs[\"dpad-down\"] as SVGRectElement;\n        this.dPadLeft = this.refs[\"dpad-left\"] as SVGRectElement;\n        this.dPadRight = this.refs[\"dpad-right\"] as SVGRectElement;\n        this.joystickHandle = this.refs[\"joystick-handle\"] as SVGCircleElement;\n\n        this.bindEvents(this.refs[\"joystick-bounds\"] as HTMLDivElement);\n\n        this.props.simulator.addChangeListener(this.buttonChangeListener);\n    }\n\n    componentWillUnmount() {\n        this.dPadUp = undefined;\n        this.dPadDown = undefined;\n        this.dPadLeft = undefined;\n        this.dPadRight = undefined;\n        this.joystickHandle = undefined;\n\n        this.props.simulator.removeChangeListener(this.buttonChangeListener);\n    }\n\n    render() {\n        const { changeMode } = this.props;\n        return (\n            <div ref=\"joystick-container\" className=\"game-joystick\">\n                <div className=\"spacer\" />\n                <div className=\"action-button\">\n                    <button className=\"share-mod-button\" onClick={() => changeMode(\"mod\")}>Mod</button>\n                </div>\n                <svg xmlns=\"http://www.w3.org/2000/svg\" ref=\"joystick-bounds\" className=\"game-joystick-svg\" viewBox=\"1 0 40 40\" width=\"200px\" height=\"200px\">\n                    <circle id=\"joystick-background\" cx=\"20\" cy=\"20\" r=\"16\" fill=\"#397382\" stroke=\"#397382\" strokeWidth=\"2\"/>\n                    <rect ref=\"dpad-up\" x=\"16\" y=\"6\" width=\"8\" height=\"12\" rx=\"2\" fill=\"#cecece\" stroke=\"none\" strokeWidth=\"1\" />\n                    <rect ref=\"dpad-down\" x=\"16\" y=\"22\" width=\"8\" height=\"12\" rx=\"2\" fill=\"#cecece\" stroke=\"none\" strokeWidth=\"1\" />\n                    <rect ref=\"dpad-right\" x=\"22\" y=\"16\" width=\"12\" height=\"8\" ry=\"2\" fill=\"#cecece\" stroke=\"none\" strokeWidth=\"1\" />\n                    <rect ref=\"dpad-left\" x=\"6\" y=\"16\" width=\"12\" height=\"8\" ry=\"2\" fill=\"#cecece\" stroke=\"none\" strokeWidth=\"1\" />\n                    <circle cx=\"20\" cy=\"20\" r=\"6\" fill=\"#cecece\" />\n                    <circle ref=\"joystick-handle\" cx=\"20\" cy=\"20\" r=\"6\" fill=\"#333\" stroke=\"#999\" strokeWidth=\"2\" />\n                </svg>\n            </div>\n        )\n    }\n\n    protected buttonChangeListener = (button: SimulatorButton, isPressed: boolean) => {\n        switch (button) {\n            case SimulatorButton.Down:\n                this.updateDirection(this.dPadDown, isPressed);\n                break;\n            case SimulatorButton.Up:\n                this.updateDirection(this.dPadUp, isPressed);\n                break;\n            case SimulatorButton.Left:\n                this.updateDirection(this.dPadLeft, isPressed);\n                break;\n            case SimulatorButton.Right:\n                this.updateDirection(this.dPadRight, isPressed);\n                break;\n        }\n    }\n\n    protected updateDirection(button: SVGRectElement | undefined, isPressed: boolean) {\n        if (button) {\n            button.setAttribute(\"fill\", isPressed ? \"#249ca3\" : \"#cecece\");\n        }\n    }\n\n    protected bindEvents(div: HTMLDivElement) {\n        if (!div) return;\n\n        if (hasPointerEvents()) {\n            this.bindPointerEvents(div);\n        }\n        else if (isTouchEnabled()) {\n            this.bindTouchEvents(div);\n        }\n        else {\n            this.bindMouseEvents(div);\n        }\n    }\n\n    protected bindPointerEvents(div: HTMLDivElement) {\n        let inGesture = false;\n\n        div.addEventListener(\"pointerup\", ev => {\n            if (inGesture) {\n                this.updateJoystickDrag(ev.clientX, ev.clientY);\n                this.startAnimation();\n            }\n            inGesture = false;\n        });\n\n        div.addEventListener(\"pointerdown\", ev => {\n            this.updateJoystickDrag(ev.clientX, ev.clientY);\n            inGesture = true\n        });\n\n        div.addEventListener(\"pointermove\", ev => {\n            if (inGesture) this.updateJoystickDrag(ev.clientX, ev.clientY);\n        });\n\n        div.addEventListener(\"pointerleave\", ev => {\n            if (inGesture) {\n                this.updateJoystickDrag(ev.clientX, ev.clientY);\n                this.startAnimation();\n            }\n            inGesture = false;\n        });\n    }\n\n    protected bindMouseEvents(div: HTMLDivElement) {\n        let inGesture = false;\n\n        div.addEventListener(\"mouseup\", ev => {\n            if (inGesture) {\n                this.updateJoystickDrag(ev.clientX, ev.clientY);\n                this.startAnimation();\n            }\n            inGesture = false;\n        });\n\n        div.addEventListener(\"mousedown\", ev => {\n            this.updateJoystickDrag(ev.clientX, ev.clientY);\n            inGesture = true\n        });\n\n        div.addEventListener(\"mousemove\", ev => {\n            if (inGesture) this.updateJoystickDrag(ev.clientX, ev.clientY);\n        });\n\n        div.addEventListener(\"mouseleave\", ev => {\n            if (inGesture) {\n                this.updateJoystickDrag(ev.clientX, ev.clientY);\n                this.startAnimation();\n            }\n            inGesture = false;\n        });\n    }\n\n    protected bindTouchEvents(div: HTMLDivElement) {\n        let touchIdentifier: number | undefined;\n\n        div.addEventListener(\"touchend\", ev => {\n            if (touchIdentifier) {\n                const touch = getTouch(ev, touchIdentifier);\n\n                if (touch) {\n                    this.updateJoystickDrag(touch.clientX, touch.clientY);\n                    this.startAnimation();\n                    ev.preventDefault();\n                }\n            }\n            touchIdentifier = undefined;\n        });\n\n        div.addEventListener(\"touchstart\", ev => {\n            touchIdentifier = ev.changedTouches[0].identifier;\n            this.updateJoystickDrag(ev.changedTouches[0].clientX, ev.changedTouches[0].clientY);\n        });\n\n        div.addEventListener(\"touchmove\", ev => {\n            if (touchIdentifier) {\n                const touch = getTouch(ev, touchIdentifier);\n\n                if (touch) {\n                    this.updateJoystickDrag(touch.clientX, touch.clientY);\n                    ev.preventDefault();\n                }\n            }\n        });\n\n        div.addEventListener(\"touchcancel\", ev => {\n            if (touchIdentifier) {\n                const touch = getTouch(ev, touchIdentifier);\n\n                if (touch) {\n                    this.updateJoystickDrag(touch.clientX, touch.clientY);\n                    this.startAnimation();\n                }\n            }\n            touchIdentifier = undefined;\n        });\n    }\n\n    protected updateJoystickDrag(x: number, y: number) {\n        if (this.joystickHandle) {\n            const bounds = (this.refs[\"joystick-bounds\"] as HTMLDivElement).getBoundingClientRect();\n\n            const dx = ((x - bounds.left) * (SVG_WIDTH / bounds.width)) - HALF_WIDTH;\n            const dy = ((y - bounds.top) * (SVG_WIDTH / bounds.height)) - HALF_WIDTH;\n\n            const angle = Math.atan2(dy, dx);\n            const distance = Math.min(Math.sqrt(Math.pow(dx, 2) + Math.pow(dy, 2)), 10);\n\n            this.setHandlePosition(HALF_WIDTH + distance * Math.cos(angle), HALF_WIDTH + distance * Math.sin(angle));\n        }\n    }\n\n    protected startAnimation() {\n        this.clearButtonPresses();\n        if (this.joystickHandle) {\n            this.stopAnimation();\n\n            const animationFrame = () => {\n                let distance = this.getHandleDistance();\n\n                if (distance < 0.5) {\n                    this.setHandlePosition(HALF_WIDTH, HALF_WIDTH, true);\n                    this.stopAnimation();\n                }\n                else {\n                    const angle = this.getHandleAngle();\n                    distance = Math.max(distance - 1, 0);\n                    this.setHandlePosition(HALF_WIDTH + distance * Math.cos(angle), HALF_WIDTH + distance * Math.sin(angle), true);\n                    this.joystickAnimation = requestAnimationFrame(animationFrame);\n                }\n            }\n\n            this.joystickAnimation = requestAnimationFrame(animationFrame);\n        }\n    }\n\n    protected stopAnimation() {\n        if (this.joystickAnimation) {\n            cancelAnimationFrame(this.joystickAnimation);\n            this.joystickAnimation = undefined;\n        }\n    }\n\n    /**\n     *\n     * @param x The x location in SVG coordinates\n     * @param y The y location in SVG coordinates\n     */\n    protected setHandlePosition(x: number, y: number, animation = false) {\n        if (this.joystickHandle) {\n            this.joystickHandle.setAttribute(\"cx\", \"\" + x)\n            this.joystickHandle.setAttribute(\"cy\", \"\" + y)\n\n            this.handleX = x;\n            this.handleY = y;\n\n            if (!animation) {\n                if (this.getHandleDistance() < 5) {\n                    this.clearButtonPresses();\n                }\n                else {\n                    const { simulator } = this.props;\n                    const angle = this.getHandleAngle();\n                    const octet = (5 + Math.floor((angle / (Math.PI / 4)) - 0.5)) % 8;\n\n                    if (octet === this.lastOctet) return;\n                    this.lastOctet = octet;\n\n                    let left = false;\n                    let right = false;\n                    let up = false;\n                    let down = false;\n\n                    switch (octet) {\n                        case 0:\n                            left = true;\n                            break;\n                        case 1:\n                            left = true;\n                            up = true;\n                            break;\n                        case 2:\n                            up = true;\n                            break;\n                        case 3:\n                            up = true;\n                            right = true;\n                            break;\n                        case 4:\n                            right = true;\n                            break;\n                        case 5:\n                            right = true;\n                            down = true;\n                            break;\n                        case 6:\n                            down = true;\n                            break;\n                        case 7:\n                            left = true;\n                            down = true;\n                            break;\n                    }\n\n                    if (down) simulator.pressButton(SimulatorButton.Down);\n                    else simulator.releaseButton(SimulatorButton.Down);\n\n                    if (up) simulator.pressButton(SimulatorButton.Up);\n                    else simulator.releaseButton(SimulatorButton.Up);\n\n                    if (left) simulator.pressButton(SimulatorButton.Left);\n                    else simulator.releaseButton(SimulatorButton.Left);\n\n                    if (right) simulator.pressButton(SimulatorButton.Right);\n                    else simulator.releaseButton(SimulatorButton.Right);\n                }\n            }\n        }\n    }\n\n    protected getHandleAngle() {\n        return Math.atan2(this.handleY - HALF_WIDTH, this.handleX - HALF_WIDTH);;\n    }\n\n    protected getHandleDistance() {\n        return Math.sqrt(Math.pow(this.handleX - HALF_WIDTH, 2) + Math.pow(this.handleY - HALF_WIDTH, 2));\n    }\n\n    protected clearButtonPresses() {\n        const { simulator } = this.props;\n        simulator.releaseButton(SimulatorButton.Down);\n        simulator.releaseButton(SimulatorButton.Up);\n        simulator.releaseButton(SimulatorButton.Left);\n        simulator.releaseButton(SimulatorButton.Right);\n        this.lastOctet = undefined;\n    }\n}\n\nfunction hasPointerEvents(): boolean {\n    return typeof window != \"undefined\" && !!(window as any).PointerEvent;\n}\n\nfunction isTouchEnabled(): boolean {\n    return typeof window !== \"undefined\" &&\n        ('ontouchstart' in window                              // works on most browsers\n            || (navigator && navigator.maxTouchPoints > 0));       // works on IE10/11 and Surface);\n}\n\nfunction getTouch(ev: TouchEvent, identifier: number) {\n    for (let i = 0; i < ev.changedTouches.length; i++) {\n        if (ev.changedTouches[i].identifier === identifier) {\n            return ev.changedTouches[i];\n        }\n    }\n\n    return undefined;\n}\n\nexport default Joystick;","import React from 'react';\n\nimport '../css/GameButtons.css';\nimport { Simulator, SimulatorButton } from './simulator';\n\nexport interface GameButtonsProps {\n    simulator: Simulator;\n    changeMode: (mode: \"play\" | \"share\" | \"mod\") => void;\n}\n\nconst SVG_WIDTH = 40;\n\nclass GameButtons extends React.Component<GameButtonsProps, {}>  {\n    protected aButton: SVGCircleElement | undefined;\n    protected aLabel: SVGTextElement | undefined;\n    protected bButton: SVGCircleElement | undefined;\n    protected bLabel: SVGTextElement | undefined;\n\n    componentDidMount() {\n        this.aButton = this.refs[\"button-a\"] as SVGCircleElement;\n        this.aLabel = this.refs[\"label-a\"] as SVGTextElement;\n        this.bButton = this.refs[\"button-b\"] as SVGCircleElement;;\n        this.bLabel = this.refs[\"label-b\"] as SVGTextElement;\n\n        this.bindEvents(this.refs[\"button-bounds\"] as HTMLElement)\n    }\n\n    componentWillUnmount() {\n        this.aButton = undefined;\n        this.aLabel = undefined;\n        this.bButton = undefined;\n        this.bLabel = undefined;\n    }\n\n    render() {\n        const { changeMode } = this.props;\n        return (\n            <div className=\"game-buttons\">\n                <div className=\"spacer\" />\n                <div className=\"action-button\">\n                    <button className=\"share-mod-button\" onClick={() => changeMode(\"share\")}>Share</button>\n                </div>\n                <svg xmlns=\"http://www.w3.org/2000/svg\" ref=\"button-bounds\" className=\"game-button-svg\" viewBox=\"0 0 40 40\" width=\"200px\" height=\"200px\">\n                    <circle ref=\"button-b\" cx=\"13\" cy=\"28\" r=\"9\" fill=\"#333\" stroke=\"#397382\" strokeWidth=\"2.5\" />\n                    <text ref=\"label-b\" x=\"13\" y=\"28\" textAnchor=\"middle\" dy=\"2.5\" fontSize=\"8\">B</text>\n                    <circle ref=\"button-a\" cx=\"28\" cy=\"11\" r=\"9\" fill=\"#333\" stroke=\"#397382\" strokeWidth=\"2.5\" />\n                    <text ref=\"label-a\" x=\"28\" y=\"11\" textAnchor=\"middle\" dy=\"2.5\" fontSize=\"8\">A</text>\n                </svg>\n            </div>\n        )\n    }\n\n    protected updateButtonGesture(x: number, y: number) {\n        const bounds = (this.refs[\"button-bounds\"] as HTMLDivElement).getBoundingClientRect();\n\n        const dx = ((x - bounds.left) * (SVG_WIDTH / bounds.width));\n        const dy = ((y - bounds.top) * (SVG_WIDTH / bounds.height));\n\n        const aDistance = Math.sqrt(Math.pow(dx - 30, 2) + Math.pow(dy - 13, 2));\n        const bDistance = Math.sqrt(Math.pow(dx - 15, 2) + Math.pow(dy - 28, 2));\n\n        this.setButtonState(SimulatorButton.A, aDistance < 8)\n        this.setButtonState(SimulatorButton.B, bDistance < 8)\n    }\n\n    protected clearButtonPresses() {\n        this.setButtonState(SimulatorButton.A, false);\n        this.setButtonState(SimulatorButton.B, false);\n    }\n\n    protected setButtonState(button: SimulatorButton, pressed: boolean) {\n        const isAButton = button === SimulatorButton.A;\n        const circle = isAButton ? this.aButton : this.bButton;\n        const label = isAButton ? this.aLabel : this.bLabel;\n\n        if (circle && label) {\n            const pressedColor = \"#249ca3\";\n            circle.setAttribute(\"fill\", pressed ? pressedColor : \"#333\")\n            label.setAttribute(\"fill\", pressed ? \"#333\" : \"\")\n        }\n\n        const { simulator } = this.props;\n        if (pressed) simulator.pressButton(button);\n        else simulator.releaseButton(button);\n    }\n\n    protected bindEvents(div: HTMLElement) {\n        if (!div) return;\n\n        if (hasPointerEvents()) {\n            this.bindPointerEvents(div);\n        }\n        else if (isTouchEnabled()) {\n            this.bindTouchEvents(div);\n        }\n        else {\n            this.bindMouseEvents(div);\n        }\n    }\n\n    protected bindPointerEvents(div: HTMLElement) {\n        let inGesture = false;\n\n        div.addEventListener(\"pointerup\", ev => {\n            if (inGesture) {\n                this.clearButtonPresses()\n            }\n            inGesture = false;\n        });\n\n        div.addEventListener(\"pointerdown\", ev => {\n            this.updateButtonGesture(ev.clientX, ev.clientY);\n            inGesture = true\n        });\n\n        div.addEventListener(\"pointermove\", ev => {\n            if (inGesture) this.updateButtonGesture(ev.clientX, ev.clientY);\n        });\n\n        div.addEventListener(\"pointerleave\", ev => {\n            if (inGesture) {\n                this.clearButtonPresses()\n            }\n            inGesture = false;\n        });\n    }\n\n    protected bindMouseEvents(div: HTMLElement) {\n        let inGesture = false;\n\n        div.addEventListener(\"mouseup\", ev => {\n            if (inGesture) {\n                this.clearButtonPresses()\n            }\n            inGesture = false;\n        });\n\n        div.addEventListener(\"mousedown\", ev => {\n            this.updateButtonGesture(ev.clientX, ev.clientY);\n            inGesture = true\n        });\n\n        div.addEventListener(\"mousemove\", ev => {\n            if (inGesture) this.updateButtonGesture(ev.clientX, ev.clientY);\n        });\n\n        div.addEventListener(\"mouseleave\", ev => {\n            if (inGesture) {\n                this.clearButtonPresses()\n            }\n            inGesture = false;\n        });\n    }\n\n    protected bindTouchEvents(div: HTMLElement) {\n        let touchIdentifier: number | undefined;\n\n        div.addEventListener(\"touchend\", ev => {\n            if (touchIdentifier) {\n                const touch = getTouch(ev, touchIdentifier);\n\n                if (touch) {\n                    this.clearButtonPresses()\n                    ev.preventDefault();\n                }\n            }\n            touchIdentifier = undefined;\n        });\n\n        div.addEventListener(\"touchstart\", ev => {\n            touchIdentifier = ev.changedTouches[0].identifier;\n            this.updateButtonGesture(ev.changedTouches[0].clientX, ev.changedTouches[0].clientY);\n        });\n\n        div.addEventListener(\"touchmove\", ev => {\n            if (touchIdentifier) {\n                const touch = getTouch(ev, touchIdentifier);\n\n                if (touch) {\n                    this.updateButtonGesture(touch.clientX, touch.clientY);\n                    ev.preventDefault();\n                }\n            }\n        });\n\n        div.addEventListener(\"touchcancel\", ev => {\n            if (touchIdentifier) {\n                const touch = getTouch(ev, touchIdentifier);\n\n                if (touch) {\n                    this.clearButtonPresses();\n                }\n            }\n            touchIdentifier = undefined;\n        });\n    }\n}\n\nfunction hasPointerEvents(): boolean {\n    return typeof window != \"undefined\" && !!(window as any).PointerEvent;\n}\n\nfunction isTouchEnabled(): boolean {\n    return typeof window !== \"undefined\" &&\n        ('ontouchstart' in window                              // works on most browsers\n            || (navigator && navigator.maxTouchPoints > 0));       // works on IE10/11 and Surface);\n}\n\nfunction getTouch(ev: TouchEvent, identifier: number) {\n    for (let i = 0; i < ev.changedTouches.length; i++) {\n        if (ev.changedTouches[i].identifier === identifier) {\n            return ev.changedTouches[i];\n        }\n    }\n\n    return undefined;\n}\n\nexport default GameButtons;","import React from 'react';\n\nimport SimFrame from './SimFrame';\nimport Joystick from './Joystick';\nimport GameButtons from './GameButtons';\n\nimport '../css/GamePlayer.css';\nimport { Simulator } from './simulator';\n\n\nlet sim: Simulator;\n\nexport interface GamePlayerProps {\n    binJs: string;\n    changeMode: (mode: \"play\" | \"share\" | \"mod\") => void;\n}\n\nconst GamePlayer: React.FC<GamePlayerProps> = props => {\n    if (!sim) sim = new Simulator();\n\n    sim.runCode(props.binJs);\n\n    return (\n        <div className=\"game-player\">\n            <Joystick simulator={sim} changeMode={props.changeMode} />\n            <SimFrame simulator={sim} />\n            <GameButtons simulator={sim} changeMode={props.changeMode} />\n            <div className=\"game-player-background\"></div>\n            <div className=\"game-player-logo\">MAKECODE</div>\n            <div className=\"game-player-msft\"></div>\n            <div className=\"game-player-vent\"></div>\n        </div>\n    );\n}\n\nexport default GamePlayer;\n","import * as events from './svgEvents'\n\nexport type Map<T> = {\n    [index: string]: T;\n};\n\nexport type PointerHandler = () => void;\n\nexport enum PatternUnits {\n    userSpaceOnUse = 0,\n    objectBoundingBox = 1,\n}\n\nexport enum LengthUnit {\n    em,\n    ex,\n    px,\n    in,\n    cm,\n    mm,\n    pt,\n    pc,\n    percent\n}\n\nconst XLINK_NAMESPACE = \"http://www.w3.org/1999/xlink\";\n\nexport class BaseElement<T extends SVGElement> {\n    el: T;\n    protected titleElement: SVGTitleElement;\n    constructor(type: string) {\n        this.el = elt(type) as T;\n    }\n    attr(attributes: Map<string | number | boolean>): this {\n        Object.keys(attributes).forEach(at => {\n            this.setAttribute(at, attributes[at]);\n        });\n        return this;\n    }\n\n    setAttribute(name: string, value: string | number | boolean): this {\n        this.el.setAttribute(name, value.toString());\n        return this;\n    }\n\n    setAttributeNS(ns: string, name: string, value: string | number | boolean): this {\n        this.el.setAttributeNS(ns, name, value.toString());\n        return this;\n    }\n\n    id(id: string): this {\n        return this.setAttribute(\"id\", id);\n    }\n\n    setClass(...classes: string[]): this {\n        return this.setAttribute(\"class\", classes.join(\" \"));\n    }\n\n\n\n    addClassInternal(el: SVGElement | HTMLElement, classes: string) {\n        classes\n            .split(/\\s+/)\n            .forEach(cls => addSingleClass(el, cls));\n\n        function addSingleClass(el: SVGElement | HTMLElement, cls: string) {\n            if (el.classList) {\n                el.classList.add(cls);\n            } else {\n                const classes = (el.className + \"\").split(/\\s+/);\n                if (classes.indexOf(cls) < 0) {\n                    el.className.baseVal += \" \" + cls;\n                }\n            }\n        }\n    }\n\n    removeClassInternal(el: SVGElement | HTMLElement, classes: string) {\n        classes\n            .split(/\\s+/)\n            .forEach(cls => removeSingleClass(el, cls));\n\n        function removeSingleClass(el: SVGElement | HTMLElement, cls: string) {\n            if (el.classList) {\n                el.classList.remove(cls);\n            } else {\n                el.className.baseVal = (el.className + \"\")\n                    .split(/\\s+/)\n                    .filter(c => c != cls)\n                    .join(\" \");\n            }\n        }\n    }\n\n\n    appendClass(className: string): this {\n        this.addClassInternal(this.el, className);\n        return this;\n    }\n\n    removeClass(className: string): void {\n        this.removeClassInternal(this.el, className);\n    }\n\n    title(text: string) {\n        if (!this.titleElement) {\n            this.titleElement = elt(\"title\");\n\n            // Title has to be the first child in the DOM\n            if (this.el.firstChild) {\n                this.el.insertBefore(this.titleElement, this.el.firstChild)\n            }\n            else {\n                this.el.appendChild(this.titleElement);\n            }\n        }\n        this.titleElement.textContent = text;\n    }\n\n    setVisible(visible: boolean): this {\n        return this.setAttribute(\"visibility\", visible ? \"visible\" : \"hidden\");\n    }\n}\n\nexport class DrawContext<T extends SVGElement> extends BaseElement<T> {\n    draw(type: \"text\"): Text;\n    draw(type: \"circle\"): Circle;\n    draw(type: \"rect\"): Rect;\n    draw(type: \"line\"): Line;\n    draw(type: \"polygon\"): Polygon;\n    draw(type: \"polyline\"): Polyline;\n    draw(type: \"path\"): Path;\n    draw(type: string): Drawable<SVGElement> {\n        const el = drawable(type as any /*FIXME?*/);\n        this.el.appendChild(el.el);\n        return el;\n    }\n\n    element(type: \"text\", cb: (newElement: Text) => void): this;\n    element(type: \"circle\", cb: (newElement: Circle) => void): this;\n    element(type: \"rect\", cb: (newElement: Rect) => void): this;\n    element(type: \"line\", cb: (newElement: Line) => void): this;\n    element(type: \"polygon\", cb: (newElement: Polygon) => void): this;\n    element(type: \"polyline\", cb: (newElement: Polyline) => void): this;\n    element(type: \"path\", cb: (newElement: Path) => void): this;\n    element(type: string, cb: (newElement: any) => void): this {\n        cb(this.draw(type as any /*FIXME?*/));\n        return this;\n    }\n\n    group(): Group {\n        const g = new Group();\n        this.el.appendChild(g.el);\n        return g;\n    }\n\n    appendChild<T extends SVGElement>(child: BaseElement<T>): void {\n        this.el.appendChild(child.el);\n    }\n\n    onDown(handler: PointerHandler): this {\n        events.down(this.el, handler);\n        return this;\n    }\n\n    onUp(handler: PointerHandler): this {\n        events.up(this.el, handler);\n        return this;\n    }\n\n    onMove(handler: PointerHandler): this {\n        events.move(this.el, handler);\n        return this;\n    }\n\n    onEnter(handler: (isDown: boolean) => void): this {\n        events.enter(this.el, handler);\n        return this;\n    }\n\n    onLeave(handler: PointerHandler): this {\n        events.leave(this.el, handler);\n        return this;\n    }\n\n    onClick(handler: PointerHandler): this {\n        events.click(this.el, handler);\n        return this;\n    }\n}\n\nexport class SVG extends DrawContext<SVGSVGElement> {\n    defs: DefsElement;\n    constructor(parent?: Element) {\n        super(\"svg\");\n        if (parent) {\n            parent.appendChild(this.el);\n        }\n    }\n\n    define(cb: (defs: DefsElement) => void): this {\n        if (!this.defs) {\n            this.defs = new DefsElement(this.el);\n        }\n        cb(this.defs);\n        return this;\n    }\n}\n\nexport class Group extends DrawContext<SVGGElement> {\n    top: number;\n    left: number;\n    scaleFactor: number;\n\n    constructor(parent?: SVGElement) {\n        super(\"g\");\n        if (parent) {\n            parent.appendChild(this.el);\n        }\n    }\n\n    translate(x: number, y: number): this {\n        this.left = x;\n        this.top = y;\n        return this.updateTransform();\n    }\n\n    scale(factor: number): this {\n        this.scaleFactor = factor;\n        return this.updateTransform();\n    }\n\n    def() {\n        return new DefsElement(this.el);\n    }\n\n    style() {\n        return new StyleElement(this.el);\n    }\n\n    private updateTransform(): this {\n        let transform = \"\";\n        if (this.left != undefined) {\n            transform += `translate(${this.left} ${this.top})`\n        }\n        if (this.scaleFactor != undefined) {\n            transform += ` scale(${this.scaleFactor})`\n        }\n        this.setAttribute(\"transform\", transform);\n        return this;\n    }\n}\n\nexport class Pattern extends DrawContext<SVGPatternElement> {\n    constructor() {\n        super(\"pattern\");\n    }\n\n    units(kind: PatternUnits): this {\n        return this.setAttribute(\"patternUnits\", kind === PatternUnits.objectBoundingBox ? \"objectBoundingBox\" : \"userSpaceOnUse\")\n    }\n\n    contentUnits(kind: PatternUnits): this {\n        return this.setAttribute(\"patternContentUnits\", kind === PatternUnits.objectBoundingBox ? \"objectBoundingBox\" : \"userSpaceOnUse\")\n    }\n\n    size(width: number, height: number): this {\n        this.setAttribute(\"width\", width);\n        this.setAttribute(\"height\", height);\n        return this;\n    }\n}\n\nexport class DefsElement extends BaseElement<SVGDefsElement> {\n    constructor(parent: SVGElement) {\n        super(\"defs\");\n        parent.appendChild(this.el);\n    }\n\n    create(type: \"path\", id: string): Path;\n    create(type: \"pattern\", id: string): Pattern;\n    create(type: \"radialGradient\", id: string): RadialGradient;\n    create(type: \"linearGradient\", id: string): LinearGradient;\n    create(type: \"clipPath\", id: string): ClipPath;\n    create(type: string, id: string): BaseElement<any> {\n        let el: BaseElement<SVGElement>;\n        switch (type) {\n            case \"path\": el = new Path(); break;\n            case \"pattern\": el = new Pattern(); break;\n            case \"radialGradient\": el = new RadialGradient(); break;\n            case \"linearGradient\": el = new LinearGradient(); break;\n            case \"clipPath\": el = new ClipPath(); break;\n            default: el = new BaseElement(type);\n        }\n        el.id(id);\n        this.el.appendChild(el.el);\n        return el;\n    }\n}\n\nexport class StyleElement extends BaseElement<SVGStyleElement> {\n    constructor(parent: SVGElement) {\n        super(\"style\");\n        parent.appendChild(this.el);\n    }\n\n    content(css: string) {\n        this.el.textContent = css;\n    }\n}\n\nexport class Drawable<T extends SVGElement> extends DrawContext<T> {\n    at(x: number, y: number): this {\n        this.setAttribute(\"x\", x);\n        this.setAttribute(\"y\", y);\n        return this;\n    }\n\n    moveTo(x: number, y: number): this {\n        return this.at(x, y);\n    }\n\n    fill(color: string, opacity?: number): this {\n        this.setAttribute(\"fill\", color);\n        if (opacity != undefined) {\n            this.opacity(opacity);\n        }\n        return this;\n    }\n\n    opacity(opacity: number): this {\n        return this.setAttribute(\"fill-opacity\", opacity);\n    }\n\n    stroke(color: string, width?: number): this {\n        this.setAttribute(\"stroke\", color);\n        if (width != undefined) {\n            this.strokeWidth(width);\n        }\n        return this;\n    }\n\n    strokeWidth(width: number): this {\n        return this.setAttribute(\"stroke-width\", width);\n    }\n\n    strokeOpacity(opacity: number): this {\n        return this.setAttribute(\"stroke-opacity\", opacity);\n    }\n\n    clipPath(url: string): this {\n        return this.setAttribute(\"clip-path\", url);\n    }\n}\n\nexport class Text extends Drawable<SVGTextElement> {\n    constructor(text?: string) {\n        super(\"text\");\n\n        if (text != undefined) {\n            this.text(text);\n        }\n    }\n\n    text(text: string): this {\n        this.el.textContent = text;\n        return this;\n    }\n\n    fontFamily(family: string) {\n        return this.setAttribute(\"font-family\", family);\n    }\n\n    fontSize(size: number, units: LengthUnit) {\n        return this.setAttribute(\"font-size\", lengthWithUnits(size, units));\n    }\n\n    offset(dx: number, dy: number, units: LengthUnit) {\n        if (dx !== 0) {\n            this.setAttribute(\"dx\", lengthWithUnits(dx, units));\n        }\n        if (dy !== 0) {\n            this.setAttribute(\"dy\", lengthWithUnits(dy, units));\n        }\n        return this;\n    }\n\n    anchor(type: \"start\" | \"middle\" | \"end\" | \"inherit\") {\n        return this.setAttribute(\"text-anchor\", type);\n    }\n}\n\nexport class Rect extends Drawable<SVGRectElement> {\n    constructor() { super(\"rect\") };\n\n    width(width: number, unit = LengthUnit.px): this {\n        return this.setAttribute(\"width\", lengthWithUnits(width, unit));\n    }\n\n    height(height: number, unit = LengthUnit.px): this {\n        return this.setAttribute(\"height\", lengthWithUnits(height, unit));\n    }\n\n    corner(radius: number): this {\n        return this.corners(radius, radius);\n    }\n\n    corners(rx: number, ry: number): this {\n        this.setAttribute(\"rx\", rx);\n        this.setAttribute(\"ry\", ry);\n        return this;\n    }\n\n    size(width: number, height: number, unit = LengthUnit.px): this {\n        this.width(width, unit);\n        this.height(height, unit);\n        return this;\n    }\n}\n\nexport class Circle extends Drawable<SVGCircleElement> {\n    constructor() { super(\"circle\"); }\n\n    at(cx: number, cy: number): this {\n        this.setAttribute(\"cx\", cx);\n        this.setAttribute(\"cy\", cy);\n        return this;\n    }\n\n    radius(r: number): this {\n        return this.setAttribute(\"r\", r);\n    }\n}\n\nclass Ellipse extends Drawable<SVGEllipseElement> {\n    constructor() { super(\"ellipse\"); }\n\n    at(cx: number, cy: number): this {\n        this.setAttribute(\"cx\", cx);\n        this.setAttribute(\"cy\", cy);\n        return this;\n    }\n\n    radius(rx: number, ry: number): this {\n        this.setAttribute(\"rx\", rx);\n        this.setAttribute(\"ry\", ry);\n        return this;\n    }\n}\n\nexport class Line extends Drawable<SVGLineElement> {\n    constructor() { super(\"line\"); }\n\n    at(x1: number, y1: number, x2?: number, y2?: number): this {\n        this.from(x1, y1);\n        if (x2 != undefined && y2 != undefined) {\n            this.to(x2, y2);\n        }\n        return this;\n    }\n\n    from(x1: number, y1: number): this {\n        this.setAttribute(\"x1\", x1);\n        this.setAttribute(\"y1\", y1);\n        return this;\n    }\n\n    to(x2: number, y2: number): this {\n        this.setAttribute(\"x2\", x2);\n        this.setAttribute(\"y2\", y2);\n        return this;\n    }\n}\n\nexport class PolyElement<T extends SVGPolygonElement | SVGPolylineElement> extends Drawable<T> {\n    points(points: string): this {\n        return this.setAttribute(\"points\", points);\n    }\n\n    with(points: {\n        x: number;\n        y: number;\n    }[]): this {\n        return this.points(points.map(({ x, y }) => x + \" \" + y).join(\",\"))\n    }\n}\n\nexport class Polyline extends PolyElement<SVGPolylineElement> {\n    constructor() { super(\"polyline\") }\n}\n\nexport class Polygon extends PolyElement<SVGPolygonElement> {\n    constructor() { super(\"polygon\") }\n}\n\nexport class Path extends Drawable<SVGPathElement> {\n    d: PathContext;\n\n    constructor() {\n        super(\"path\");\n        this.d = new PathContext();\n    }\n\n    update(): this {\n        return this.setAttribute(\"d\", this.d.toAttribute());\n    }\n\n    path(cb: (d: PathContext) => void): this {\n        cb(this.d);\n        return this.update();\n    }\n}\n\nexport class Image extends Drawable<SVGImageElement> {\n    constructor() { super(\"image\") }\n\n    src(url: string) {\n        return this.setAttributeNS(XLINK_NAMESPACE, \"href\", url);\n    }\n\n    width(width: number, unit = LengthUnit.px): this {\n        return this.setAttribute(\"width\", lengthWithUnits(width, unit));\n    }\n\n    height(height: number, unit = LengthUnit.px): this {\n        return this.setAttribute(\"height\", lengthWithUnits(height, unit));\n    }\n\n    size(width: number, height: number, unit = LengthUnit.px): this {\n        this.width(width, unit);\n        this.height(height, unit);\n        return this;\n    }\n}\n\nexport class Gradient<T extends SVGGradientElement> extends BaseElement<T> {\n    units(kind: PatternUnits): this {\n        return this.setAttribute(\"gradientUnits\", kind === PatternUnits.objectBoundingBox ? \"objectBoundingBox\" : \"userSpaceOnUse\")\n    }\n\n    stop(offset: number, color?: string, opacity?: string): this {\n        const s = elt(\"stop\");\n        s.setAttribute(\"offset\", offset + \"%\");\n        if (color != undefined) {\n            s.setAttribute(\"stop-color\", color);\n        }\n\n        if (opacity != undefined) {\n            s.setAttribute(\"stop-opacity\", opacity);\n        }\n\n        this.el.appendChild(s);\n        return this;\n    }\n}\n\nexport class LinearGradient extends Gradient<SVGLinearGradientElement> {\n    constructor() { super(\"linearGradient\"); }\n\n    start(x1: number, y1: number): this {\n        this.setAttribute(\"x1\", x1);\n        this.setAttribute(\"y1\", y1);\n        return this;\n    }\n\n    end(x2: number, y2: number): this {\n        this.setAttribute(\"x2\", x2);\n        this.setAttribute(\"y2\", y2);\n        return this;\n    }\n}\n\nexport class RadialGradient extends Gradient<SVGRadialGradientElement> {\n    constructor() { super(\"radialGradient\"); }\n\n    center(cx: number, cy: number): this {\n        this.setAttribute(\"cx\", cx);\n        this.setAttribute(\"cy\", cy);\n        return this;\n    }\n\n    focus(fx: number, fy: number, fr: number): this {\n        this.setAttribute(\"fx\", fx);\n        this.setAttribute(\"fy\", fy);\n        this.setAttribute(\"fr\", fr);\n        return this;\n    }\n\n    radius(r: number): this {\n        return this.setAttribute(\"r\", r);\n    }\n}\n\nexport class ClipPath extends DrawContext<SVGClipPathElement> {\n    constructor() { super(\"clipPath\") }\n\n    clipPathUnits(objectBoundingBox: boolean) {\n        if (objectBoundingBox) {\n            return this.setAttribute(\"clipPathUnits\", \"objectBoundingBox\");\n        }\n        else {\n            return this.setAttribute(\"clipPathUnits\", \"userSpaceOnUse\");\n        }\n    }\n}\n\nfunction elt(type: string): SVGElement {\n    let el = document.createElementNS(\"http://www.w3.org/2000/svg\", type);\n    return el;\n}\n\nfunction drawable(type: \"text\"): Text;\nfunction drawable(type: \"circle\"): Circle;\nfunction drawable(type: \"rect\"): Rect;\nfunction drawable(type: \"line\"): Line;\nfunction drawable(type: \"polygon\"): Polygon;\nfunction drawable(type: \"polyline\"): Polyline;\nfunction drawable(type: \"path\"): Path;\nfunction drawable(type: string): Drawable<SVGElement> {\n    switch (type) {\n        case \"text\": return new Text();\n        case \"circle\": return new Circle();\n        case \"rect\": return new Rect();\n        case \"line\": return new Line();\n        case \"polygon\": return new Polygon();\n        case \"polyline\": return new Polyline();\n        case \"path\": return new Path();\n        default: return new Drawable(type);\n    }\n}\n\nexport type OperatorSymbol = \"m\" | \"M\" | \"l\" | \"L\" | \"c\" | \"C\" | \"q\" | \"Q\" | \"T\" | \"t\" | \"S\" | \"s\" | \"z\" | \"Z\" | \"A\" | \"a\";\nexport interface PathOp {\n    op: OperatorSymbol;\n    args: number[];\n}\nexport class PathContext {\n    private ops: PathOp[] = [];\n\n    clear(): void {\n        this.ops = [];\n    }\n\n    moveTo(x: number, y: number): this {\n        return this.op(\"M\", x, y);\n    }\n\n    moveBy(dx: number, dy: number): this {\n        return this.op(\"m\", dx, dy);\n    }\n\n    lineTo(x: number, y: number): this {\n        return this.op(\"L\", x, y);\n    }\n\n    lineBy(dx: number, dy: number): this {\n        return this.op(\"l\", dx, dy);\n    }\n\n    cCurveTo(c1x: number, c1y: number, c2x: number, c2y: number, x: number, y: number): this {\n        return this.op(\"C\", c1x, c1y, c2x, c2y, x, y);\n    }\n\n    cCurveBy(dc1x: number, dc1y: number, dc2x: number, dc2y: number, dx: number, dy: number): this {\n        return this.op(\"c\", dc1x, dc1y, dc2x, dc2y, dx, dy);\n    }\n\n    qCurveTo(cx: number, cy: number, x: number, y: number): this {\n        return this.op(\"Q\", cx, cy, x, y);\n    }\n\n    qCurveBy(dcx: number, dcy: number, dx: number, dy: number): this {\n        return this.op(\"q\", dcx, dcy, dx, dy);\n    }\n\n    sCurveTo(cx: number, cy: number, x: number, y: number): this {\n        return this.op(\"S\", cx, cy, x, y);\n    }\n\n    sCurveBy(dcx: number, dcy: number, dx: number, dy: number): this {\n        return this.op(\"s\", dcx, dcy, dx, dy);\n    }\n\n    tCurveTo(x: number, y: number): this {\n        return this.op(\"T\", x, y);\n    }\n\n    tCurveBy(dx: number, dy: number): this {\n        return this.op(\"t\", dx, dy);\n    }\n\n    arcTo(rx: number, ry: number, xRotate: number, large: boolean, sweepClockwise: boolean, x: number, y: number): this {\n        return this.op(\"A\", rx, ry, xRotate, large ? 1 : 0, sweepClockwise ? 1 : 0, x, y);\n    }\n\n    arcBy(rx: number, ry: number, xRotate: number, large: boolean, sweepClockwise: boolean, x: number, y: number): this {\n        return this.op(\"a\", rx, ry, xRotate, large ? 1 : 0, sweepClockwise ? 1 : 0, x, y);\n    }\n\n    close(): this {\n        return this.op(\"z\");\n    }\n\n    toAttribute(): string {\n        return this.ops.map(op => op.op + \" \" + op.args.join(\" \")).join(\" \");\n    }\n\n    private op(op: OperatorSymbol, ...args: number[]) {\n        this.ops.push({\n            op,\n            args\n        });\n        return this;\n    }\n}\n\nfunction lengthWithUnits(value: number, unit: LengthUnit) {\n    switch (unit) {\n        case LengthUnit.em: return value + \"em\";\n        case LengthUnit.ex: return value + \"ex\";\n        case LengthUnit.px: return value + \"px\";\n        case LengthUnit.in: return value + \"in\";\n        case LengthUnit.cm: return value + \"cm\";\n        case LengthUnit.mm: return value + \"mm\";\n        case LengthUnit.pt: return value + \"pt\";\n        case LengthUnit.pc: return value + \"pc\";\n        case LengthUnit.percent: return value + \"%\";\n        default: return value.toString();\n    }\n}","\n\nexport function isTouchEnabled(): boolean {\n    return typeof window !== \"undefined\" &&\n        ('ontouchstart' in window                              // works on most browsers\n            || (navigator && navigator.maxTouchPoints > 0));       // works on IE10/11 and Surface);\n}\n\nexport function hasPointerEvents(): boolean {\n    return typeof window != \"undefined\" && !!(window as any).PointerEvent;\n}\n\nexport function down(el: SVGElement, handler: () => void) {\n    if (hasPointerEvents()) {\n        el.addEventListener(\"pointerdown\", handler);\n    }\n    else if (isTouchEnabled()) {\n        el.addEventListener(\"mousedown\", handler);\n        el.addEventListener(\"touchstart\", handler);\n    }\n    else {\n        el.addEventListener(\"mousedown\", handler);\n    }\n}\n\nexport function up(el: SVGElement, handler: () => void) {\n    if (hasPointerEvents()) {\n        el.addEventListener(\"pointerup\", handler);\n    }\n    else if (isTouchEnabled()) {\n        el.addEventListener(\"mouseup\", handler);\n    }\n    else {\n        el.addEventListener(\"mouseup\", handler);\n    }\n}\n\nexport function enter(el: SVGElement, handler: (isDown: boolean) => void) {\n    if (hasPointerEvents()) {\n        el.addEventListener(\"pointerover\", e => {\n            handler(!!(e.buttons & 1))\n        });\n    }\n    else if (isTouchEnabled()) {\n        el.addEventListener(\"touchstart\", e => {\n            handler(true);\n        });\n    }\n    else {\n        el.addEventListener(\"mouseover\", e => {\n            handler(!!(e.buttons & 1))\n        });\n    }\n}\n\nexport function leave(el: SVGElement, handler: () => void) {\n    if (hasPointerEvents()) {\n        el.addEventListener(\"pointerleave\", handler);\n    }\n    else if (isTouchEnabled()) {\n        el.addEventListener(\"touchend\", handler);\n    }\n    else {\n        el.addEventListener(\"mouseleave\", handler);\n    }\n}\n\nexport function move(el: SVGElement, handler: () => void) {\n    if (hasPointerEvents()) {\n        el.addEventListener(\"pointermove\", handler);\n    }\n    else if (isTouchEnabled()) {\n        el.addEventListener(\"touchmove\", handler);\n    }\n    else {\n        el.addEventListener(\"mousemove\", handler);\n    }\n}\n\nexport function click(el: SVGElement, handler: () => void) {\n    el.addEventListener(\"click\", handler);\n}","export const DRAG_RADIUS = 3;\n\nexport function hasPointerEvents(): boolean {\n    return typeof window != \"undefined\" && !!(window as any).PointerEvent;\n}\n\nexport function isTouchEnabled(): boolean {\n    return typeof window !== \"undefined\" &&\n        ('ontouchstart' in window                              // works on most browsers\n            || (navigator && navigator.maxTouchPoints > 0));       // works on IE10/11 and Surface);\n}\n\nexport enum MapTools {\n    Pan,\n    Stamp,\n    Erase\n}\n\nexport class Bitmask {\n    protected mask: Uint8Array;\n\n    constructor(public width: number, public height: number) {\n        this.mask = new Uint8Array(Math.ceil(width * height / 8));\n    }\n\n    set(col: number, row: number) {\n        const cellIndex = col + this.width * row;\n        const index = cellIndex >> 3;\n        const offset = cellIndex & 7;\n        this.mask[index] |= (1 << offset);\n    }\n\n    get(col: number, row: number) {\n        const cellIndex = col + this.width * row;\n        const index = cellIndex >> 3;\n        const offset = cellIndex & 7;\n        return (this.mask[index] >> offset) & 1;\n    }\n}\n\nexport interface IPointerEvents {\n    up: string,\n    down: string[],\n    move: string,\n    enter: string,\n    leave: string\n}\n\nexport const pointerEvents: IPointerEvents = (() => {\n    if (hasPointerEvents()) {\n        return {\n            up: \"pointerup\",\n            down: [\"pointerdown\"],\n            move: \"pointermove\",\n            enter: \"pointerenter\",\n            leave: \"pointerleave\"\n        }\n    } else if (isTouchEnabled()) {\n        return {\n            up: \"mouseup\",\n            down: [\"mousedown\", \"touchstart\"],\n            move: \"touchmove\",\n            enter: \"touchenter\",\n            leave: \"touchend\"\n        }\n    } else {\n        return {\n            up: \"mouseup\",\n            down: [\"mousedown\"],\n            move: \"mousemove\",\n            enter: \"mouseenter\",\n            leave: \"mouseleave\"\n        }\n    }\n})();\n\nexport interface ClientCoordinates {\n    clientX: number;\n    clientY: number;\n}\n\nexport function clientCoord(ev: PointerEvent | MouseEvent | TouchEvent): ClientCoordinates {\n    if ((ev as TouchEvent).touches) {\n        const te = ev as TouchEvent;\n        if (te.touches.length) {\n            return te.touches[0];\n        }\n        return te.changedTouches[0];\n    }\n    return (ev as PointerEvent | MouseEvent);\n}\n\nexport async function loadImageAsync(src: string) {\n    return new Promise<HTMLImageElement>((resolve, reject) => {\n        const el = document.createElement(\"img\");\n\n        el.onload = () => resolve(el);\n        el.onerror = () => reject('');\n\n        el.src = src;\n    })\n}\n\nexport interface GestureTarget {\n    onClick(coord: ClientCoordinates): void;\n    onDragStart(coord: ClientCoordinates): void;\n    onDragMove(coord: ClientCoordinates): void;\n    onDragEnd(coord: ClientCoordinates): void;\n}\n\nexport class GestureState {\n    startX: number;\n    startY: number;\n\n    currentX: number;\n    currentY: number;\n\n    isDrag: boolean;\n\n    constructor(protected target: GestureTarget, coord: ClientCoordinates) {\n        this.startX = coord.clientX;\n        this.startY = coord.clientY;\n\n        this.currentX = coord.clientX;\n        this.currentY = coord.clientY;\n    }\n\n    update(coord: ClientCoordinates) {\n        this.currentX = coord.clientX;\n        this.currentY = coord.clientY;\n\n        if (!this.isDrag && this.distance() > DRAG_RADIUS) {\n            this.isDrag = true;\n            this.target.onDragStart(coord);\n        }\n        else if (this.isDrag) {\n            this.target.onDragMove(coord);\n        }\n    }\n\n    end(coord?: ClientCoordinates) {\n        if (coord) {\n            this.update(coord);\n        }\n\n        coord = coord || { clientX: this.currentX, clientY: this.currentY };\n\n        if (this.isDrag) {\n            this.target.onDragEnd(coord);\n        }\n        else {\n            this.target.onClick(coord);\n        }\n    }\n\n    distance() {\n        return Math.sqrt(Math.pow(this.currentX - this.startX, 2) + Math.pow(this.currentY - this.startY, 2));\n    }\n}\n\nexport function bindGestureEvents(el: HTMLElement, target: GestureTarget) {\n    let state: GestureState;\n\n    let upHandler = (ev: MouseEvent) => {\n        endGesture(ev);\n\n        ev.stopPropagation();\n        ev.preventDefault();\n    };\n\n    let leaveHandler = (ev: MouseEvent) => {\n        endGesture(ev);\n\n        ev.stopPropagation();\n        ev.preventDefault();\n    };\n\n    let moveHandler = (ev: MouseEvent) => {\n        if (state) state.update(clientCoord(ev));\n\n        ev.stopPropagation();\n        ev.preventDefault();\n    };\n\n    let startGesture = (ev: MouseEvent | PointerEvent | TouchEvent) => {\n        if (state) state.end();\n\n        state = new GestureState(target, clientCoord(ev));\n\n        document.addEventListener(pointerEvents.move, <EventListener>moveHandler);\n        document.addEventListener(pointerEvents.up, <EventListener>upHandler);\n\n        if (isTouchEnabled() && !hasPointerEvents()) {\n            document.addEventListener(\"touchend\", <EventListener>upHandler);\n            document.addEventListener(\"touchcancel\", <EventListener>leaveHandler);\n        }\n        else {\n            document.addEventListener(pointerEvents.leave, <EventListener>leaveHandler);\n        }\n    }\n\n    let endGesture = (ev: MouseEvent | PointerEvent | TouchEvent) => {\n        if (state) state.end(clientCoord(ev));\n\n        state = undefined;\n\n        document.removeEventListener(pointerEvents.move, <EventListener>moveHandler);\n        document.removeEventListener(pointerEvents.up, <EventListener>upHandler);\n        document.removeEventListener(pointerEvents.leave, <EventListener>leaveHandler);\n\n        if (isTouchEnabled() && !hasPointerEvents()) {\n            document.removeEventListener(\"touchend\", <EventListener>upHandler);\n            document.removeEventListener(\"touchcancel\", <EventListener>leaveHandler);\n        }\n        else {\n            document.removeEventListener(pointerEvents.leave, <EventListener>leaveHandler);\n        }\n    }\n\n    pointerEvents.down.forEach(evId => {\n        el.addEventListener(evId, <EventListener>startGesture);\n    });\n}","import { CanvasState } from './canvasState'\nimport { Coord } from './bitmap';\nimport { Bitmask } from './util';\n\nexport enum PaintTool {\n    Normal = 0,\n    Rectangle = 1,\n    Outline = 2,\n    Circle = 3,\n    Fill = 4,\n    Line = 5,\n    Erase = 6,\n    Marquee = 7,\n}\n\nexport function getPaintToolShortcut(tool: PaintTool) {\n    switch (tool) {\n        case PaintTool.Normal:\n            return \"p\";\n        case PaintTool.Rectangle:\n            return \"r\";\n        case PaintTool.Circle:\n            return \"c\";\n        case PaintTool.Fill:\n            return \"b\";\n        case PaintTool.Line:\n            return \"l\";\n        case PaintTool.Erase:\n            return \"e\";\n        case PaintTool.Marquee:\n            return \"s\";\n        default:\n            return undefined;\n    }\n}\n\nexport class Cursor {\n    offsetX: number;\n    offsetY: number;\n    constructor(public readonly width: number, public readonly height: number) {\n        this.offsetX = -(width >> 1);\n        this.offsetY = -(height >> 1);\n    }\n}\n\nexport abstract class Edit {\n    protected startCol: number;\n    protected startRow: number;\n    isStarted: boolean;\n    showPreview: boolean;\n\n    constructor(protected canvasWidth: number, protected canvasHeight: number, public color: number, protected toolWidth: number) {\n    }\n\n    public abstract update(col: number, row: number): void;\n    protected abstract doEditCore(state: CanvasState): void;\n\n    public doEdit(state: CanvasState): void {\n        if (this.isStarted) {\n            this.doEditCore(state);\n        }\n    }\n\n\n    start(cursorCol: number, cursorRow: number, state: CanvasState) {\n        this.isStarted = true;\n        this.startCol = cursorCol;\n        this.startRow = cursorRow;\n\n        state.mergeFloatingLayer();\n    }\n\n\n    end(col: number, row: number, state: CanvasState): void {\n\n    }\n\n\n    getCursor(): Cursor {\n        return new Cursor(this.toolWidth, this.toolWidth);\n    }\n\n    drawCursor(col: number, row: number, draw: (c: number, r: number) => void) {\n        draw(col, row);\n    }\n}\n\nexport abstract class SelectionEdit extends Edit {\n    protected endCol: number;\n    protected endRow: number;\n    protected isDragged: boolean;\n\n    update(col: number, row: number) {\n        this.endCol = col;\n        this.endRow = row;\n\n        if (!this.isDragged && !(col == this.startCol && row == this.startRow)) {\n            this.isDragged = true;\n        }\n    }\n\n    protected topLeft(): Coord {\n        return {\n            x: Math.min(this.startCol, this.endCol),\n            y: Math.min(this.startRow, this.endRow)\n        };\n    }\n\n    protected bottomRight(): Coord {\n        return {\n            x: Math.max(this.startCol, this.endCol),\n            y: Math.max(this.startRow, this.endRow)\n        };\n    }\n}\n\n/**\n * Regular old drawing tool\n */\nexport class PaintEdit extends Edit {\n    protected mask: Bitmask;\n    showPreview = true;\n\n    constructor(canvasWidth: number, canvasHeight: number, color: number, toolWidth: number) {\n        super(canvasWidth, canvasHeight, color, toolWidth);\n        this.mask = new Bitmask(canvasWidth, canvasHeight);\n    }\n\n    update(col: number, row: number) {\n        // Interpolate (Draw a line) from startCol, startRow to col, row\n        this.interpolate(this.startCol, this.startRow, col, row);\n\n        this.startCol = col;\n        this.startRow = row;\n    }\n\n    // https://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm\n    protected interpolate(x0: number, y0: number, x1: number, y1: number) {\n        const dx = x1 - x0;\n        const dy = y1 - y0;\n        const draw = (c: number, r: number) => this.mask.set(c, r);\n        if (dx === 0) {\n            const startY = dy >= 0 ? y0 : y1;\n            const endY = dy >= 0 ? y1 : y0;\n            for (let y = startY; y <= endY; y++) {\n                this.drawCore(x0, y, draw);\n            }\n            return;\n        }\n\n        const xStep = dx > 0 ? 1 : -1;\n        const yStep = dy > 0 ? 1 : -1;\n        const dErr = Math.abs(dy / dx);\n\n        let err = 0;\n        let y = y0;\n        for (let x = x0; xStep > 0 ? x <= x1 : x >= x1; x += xStep) {\n            this.drawCore(x, y, draw);\n            err += dErr;\n            while (err >= 0.5) {\n                if (yStep > 0 ? y <= y1 : y >= y1) {\n                    this.drawCore(x, y, draw);\n                }\n                y += yStep;\n                err -= 1;\n            }\n        }\n    }\n\n    protected doEditCore(state: CanvasState) {\n        for (let c = 0; c < state.width; c++) {\n            for (let r = 0; r < state.height; r++) {\n                if (this.mask.get(c, r)) {\n                    state.image.set(c, r, this.color);\n                }\n            }\n        }\n    }\n\n    drawCursor(col: number, row: number, draw: (c: number, r: number) => void) {\n        this.drawCore(col, row, draw);\n    }\n\n    protected drawCore(col: number, row: number, setPixel: (col: number, row: number) => void) {\n        col = col - Math.floor(this.toolWidth / 2);\n        row = row - Math.floor(this.toolWidth / 2);\n        for (let i = 0; i < this.toolWidth; i++) {\n            for (let j = 0; j < this.toolWidth; j++) {\n                const c = col + i;\n                const r = row + j;\n\n                if (c >= 0 && c < this.canvasWidth && r >= 0 && r < this.canvasHeight) {\n                    setPixel(col + i, row + j);\n                }\n            }\n        }\n    }\n}\n\n/**\n * Tool for drawing filled rectangles\n */\nexport class RectangleEdit extends SelectionEdit {\n    showPreview = true;\n\n    protected doEditCore(state: CanvasState) {\n        const tl = this.topLeft();\n        const br = this.bottomRight();\n        for (let c = tl.x; c <= br.x; c++) {\n            for (let r = tl.y; r <= br.y; r++) {\n                state.image.set(c, r, this.color);\n            }\n        }\n    }\n}\n\n/**\n * Tool for drawing empty rectangles\n */\nexport class OutlineEdit extends SelectionEdit {\n    showPreview = true;\n\n    protected doEditCore(state: CanvasState) {\n        let tl = this.topLeft();\n        tl.x -= this.toolWidth >> 1;\n        tl.y -= this.toolWidth >> 1;\n\n        let br = this.bottomRight();\n        br.x += this.toolWidth >> 1;\n        br.y += this.toolWidth >> 1;\n\n        for (let i = 0; i < this.toolWidth; i++) {\n            this.drawRectangle(state,\n                { x: tl.x + i, y: tl.y + i },\n                { x: br.x - i, y: br.y - i }\n            );\n        }\n    }\n\n    protected drawRectangle(state: CanvasState, tl: Coord, br: Coord) {\n        if (tl.x > br.x || tl.y > br.y) return;\n\n        for (let c = tl.x; c <= br.x; c++) {\n            state.image.set(c, tl.y, this.color);\n            state.image.set(c, br.y, this.color);\n        }\n        for (let r = tl.y; r <= br.y; r++) {\n            state.image.set(tl.x, r, this.color);\n            state.image.set(br.x, r, this.color);\n        }\n    }\n\n    drawCursor(col: number, row: number, draw: (c: number, r: number) => void) {\n        this.drawCore(col, row, draw);\n    }\n\n    protected drawCore(col: number, row: number, setPixel: (col: number, row: number) => void) {\n        col = col - Math.floor(this.toolWidth / 2);\n        row = row - Math.floor(this.toolWidth / 2);\n        for (let i = 0; i < this.toolWidth; i++) {\n            for (let j = 0; j < this.toolWidth; j++) {\n                const c = col + i;\n                const r = row + j;\n\n                if (c >= 0 && c < this.canvasWidth && r >= 0 && r < this.canvasHeight) {\n                    setPixel(col + i, row + j);\n                }\n            }\n        }\n    }\n\n}\n\n/**\n * Tool for drawing straight lines\n */\nexport class LineEdit extends SelectionEdit {\n    showPreview = true;\n\n    protected doEditCore(state: CanvasState) {\n        this.bresenham(this.startCol, this.startRow, this.endCol, this.endRow, state);\n    }\n\n    // https://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm\n    protected bresenham(x0: number, y0: number, x1: number, y1: number, state: CanvasState) {\n        const dx = x1 - x0;\n        const dy = y1 - y0;\n        const draw = (c: number, r: number) => state.image.set(c, r, this.color);\n        if (dx === 0) {\n            const startY = dy >= 0 ? y0 : y1;\n            const endY = dy >= 0 ? y1 : y0;\n            for (let y = startY; y <= endY; y++) {\n                this.drawCore(x0, y, draw);\n            }\n            return;\n        }\n\n        const xStep = dx > 0 ? 1 : -1;\n        const yStep = dy > 0 ? 1 : -1;\n        const dErr = Math.abs(dy / dx);\n\n        let err = 0;\n        let y = y0;\n        for (let x = x0; xStep > 0 ? x <= x1 : x >= x1; x += xStep) {\n            this.drawCore(x, y, draw);\n            err += dErr;\n            while (err >= 0.5) {\n                if (yStep > 0 ? y <= y1 : y >= y1) {\n                    this.drawCore(x, y, draw);\n                }\n                y += yStep;\n                err -= 1;\n            }\n        }\n    }\n\n    drawCursor(col: number, row: number, draw: (c: number, r: number) => void) {\n        this.drawCore(col, row, draw);\n    }\n\n    // This is surely not the most efficient approach for drawing thick lines...\n    protected drawCore(col: number, row: number, draw: (c: number, r: number) => void) {\n        col = col - Math.floor(this.toolWidth / 2);\n        row = row - Math.floor(this.toolWidth / 2);\n        for (let i = 0; i < this.toolWidth; i++) {\n            for (let j = 0; j < this.toolWidth; j++) {\n                const c = col + i;\n                const r = row + j;\n\n                draw(c, r);\n            }\n        }\n    }\n}\n\n/**\n * Tool for circular outlines\n */\nexport class CircleEdit extends SelectionEdit {\n    showPreview = true;\n\n    protected doEditCore(state: CanvasState) {\n        const tl = this.topLeft();\n        const br = this.bottomRight();\n        const dx = br.x - tl.x;\n        const dy = br.y - tl.y;\n\n        const radius = Math.floor(Math.hypot(dx, dy));\n        const cx = this.startCol;\n        const cy = this.startRow;\n\n        this.midpoint(cx, cy, radius, state);\n    }\n\n    // https://en.wikipedia.org/wiki/Midpoint_circle_algorithm\n    midpoint(cx: number, cy: number, radius: number, state: CanvasState) {\n        let x = radius - 1;\n        let y = 0;\n        let dx = 1;\n        let dy = 1;\n        let err = dx - (radius * 2);\n        while (x >= y) {\n            state.image.set(cx + x, cy + y, this.color);\n            state.image.set(cx + x, cy - y, this.color);\n            state.image.set(cx + y, cy + x, this.color);\n            state.image.set(cx + y, cy - x, this.color);\n            state.image.set(cx - y, cy + x, this.color);\n            state.image.set(cx - y, cy - x, this.color);\n            state.image.set(cx - x, cy + y, this.color);\n            state.image.set(cx - x, cy - y, this.color);\n            if (err <= 0) {\n                y++;\n                err += dy;\n                dy += 2;\n            }\n            if (err > 0) {\n                x--;\n                dx += 2;\n                err += dx - (radius * 2);\n            }\n        }\n    }\n\n    getCursor(): Cursor {\n        return new Cursor(1, 1);\n    }\n}\n\n\nexport class FillEdit extends Edit {\n    protected col: number;\n    protected row: number;\n    showPreview = true;\n\n    start(col: number, row: number, state: CanvasState) {\n        this.isStarted = true;\n        this.col = col;\n        this.row = row;\n\n        state.mergeFloatingLayer();\n    }\n\n    update(col: number, row: number) {\n        this.col = col;\n        this.row = row;\n    }\n\n    protected doEditCore(state: CanvasState) {\n        const replColor = state.image.get(this.col, this.row);\n        if (replColor === this.color) {\n            return;\n        }\n\n        const mask = new Bitmask(state.width, state.height);\n        mask.set(this.col, this.row);\n        const q: Coord[] = [{ x: this.col, y: this.row }];\n        while (q.length) {\n            const curr = q.pop();\n            if (state.image.get(curr.x, curr.y) === replColor) {\n                state.image.set(curr.x, curr.y, this.color);\n                tryPush(curr.x + 1, curr.y);\n                tryPush(curr.x - 1, curr.y);\n                tryPush(curr.x, curr.y + 1);\n                tryPush(curr.x, curr.y - 1);\n            }\n        }\n\n        function tryPush(x: number, y: number) {\n            if (x >= 0 && x < mask.width && y >= 0 && y < mask.height && !mask.get(x, y)) {\n                mask.set(x, y);\n                q.push({ x: x, y: y });\n            }\n        }\n    }\n\n    getCursor(): Cursor {\n        return new Cursor(1, 1);\n    }\n}\n\n\nexport class MarqueeEdit extends SelectionEdit {\n    protected isMove = false;\n    showPreview = false;\n\n    start(cursorCol: number, cursorRow: number, state: CanvasState) {\n        this.isStarted = true;\n        this.startCol = cursorCol;\n        this.startRow = cursorRow;\n        if (state.floatingLayer) {\n            if (state.inFloatingLayer(cursorCol, cursorRow)) {\n                this.isMove = true;\n            } else {\n                state.mergeFloatingLayer();\n            }\n        }\n    }\n\n    end(cursorCol: number, cursorRow: number, state: CanvasState) {\n        if (!this.isDragged && state.floatingLayer) {\n            state.mergeFloatingLayer();\n        }\n    }\n\n    protected doEditCore(state: CanvasState): void {\n        const tl = this.topLeft();\n        const br = this.bottomRight();\n\n        if (this.isDragged) {\n            if (this.isMove) {\n                state.layerOffsetX = state.floatingLayer.x0 + this.endCol - this.startCol;\n                state.layerOffsetY = state.floatingLayer.y0 + this.endRow - this.startRow;\n            }\n            else {\n                state.copyToLayer(tl.x, tl.y, br.x - tl.x + 1, br.y - tl.y + 1, true);\n            }\n        }\n    }\n\n    getCursor(): Cursor {\n        return undefined;\n    }\n}","import * as svg from './svgUtil'\n\nexport interface ButtonGroup {\n    root: svg.Group;\n    cx: number;\n    cy: number;\n}\n\nconst TOGGLE_WIDTH = 200;\nconst TOGGLE_HEIGHT = 40;\nconst TOGGLE_BORDER_WIDTH = 2;\nconst TOGGLE_CORNER_RADIUS = 4;\n\nconst BUTTON_CORNER_RADIUS = 2;\nconst BUTTON_BORDER_WIDTH = 1;\nconst BUTTON_BOTTOM_BORDER_WIDTH = 2;\n\nexport interface ToggleProps {\n    baseColor: string;\n    borderColor: string;\n    backgroundColor: string;\n    switchColor: string;\n    unselectedTextColor: string;\n    selectedTextColor: string;\n\n    leftText: string;\n    leftIcon: string;\n\n    rightText: string;\n    rightIcon: string;\n}\n\nexport class Toggle {\n    protected leftElement: svg.Group;\n    protected leftText: svg.Text;\n    protected rightElement: svg.Group;\n    protected rightText: svg.Text;\n\n    protected switch: svg.Rect;\n    protected root: svg.Group;\n    protected props: ToggleProps;\n\n    protected isLeft: boolean;\n    protected changeHandler: (left: boolean) => void;\n\n    constructor(parent: svg.SVG, props: Partial<ToggleProps>) {\n        this.props = defaultColors(props);\n        this.root = parent.group();\n        this.buildDom();\n        this.isLeft = true;\n    }\n\n    protected buildDom() {\n        // Our css minifier mangles animation names so they need to be injected manually\n        this.root.style().content(`\n            .toggle-left {\n                transform: translateX(0px);\n                animation: mvleft 0.2s 0s ease;\n            }\n\n            .toggle-right {\n                transform: translateX(100px);\n                animation: mvright 0.2s 0s ease;\n            }\n\n            @keyframes mvright {\n                0% {\n                    transform: translateX(0px);\n                }\n                100% {\n                    transform: translateX(100px);\n                }\n            }\n\n            @keyframes mvleft {\n                0% {\n                    transform: translateX(100px);\n                }\n                100% {\n                    transform: translateX(0px);\n                }\n            }\n            `);\n\n\n        // The outer border has an inner-stroke so we need to clip out the outer part\n        // because SVG's don't support \"inner borders\"\n        const clip = this.root.def().create(\"clipPath\", \"sprite-editor-toggle-border\")\n            .clipPathUnits(true);\n\n        clip.draw(\"rect\")\n            .at(0, 0)\n            .corners(TOGGLE_CORNER_RADIUS / TOGGLE_WIDTH, TOGGLE_CORNER_RADIUS / TOGGLE_HEIGHT)\n            .size(1, 1);\n\n        // Draw the outer border\n        this.root.draw(\"rect\")\n            .size(TOGGLE_WIDTH, TOGGLE_HEIGHT)\n            .fill(this.props.baseColor)\n            .stroke(this.props.borderColor, TOGGLE_BORDER_WIDTH * 2)\n            .corners(TOGGLE_CORNER_RADIUS, TOGGLE_CORNER_RADIUS)\n            .clipPath(\"url(#sprite-editor-toggle-border)\");\n\n\n        // Draw the background\n        this.root.draw(\"rect\")\n            .at(TOGGLE_BORDER_WIDTH, TOGGLE_BORDER_WIDTH)\n            .size(TOGGLE_WIDTH - TOGGLE_BORDER_WIDTH * 2, TOGGLE_HEIGHT - TOGGLE_BORDER_WIDTH * 2)\n            .fill(this.props.backgroundColor)\n            .corners(TOGGLE_CORNER_RADIUS, TOGGLE_CORNER_RADIUS);\n\n        // Draw the switch\n        this.switch = this.root.draw(\"rect\")\n            .at(TOGGLE_BORDER_WIDTH, TOGGLE_BORDER_WIDTH)\n            .size((TOGGLE_WIDTH - TOGGLE_BORDER_WIDTH * 2) / 2, TOGGLE_HEIGHT - TOGGLE_BORDER_WIDTH * 2)\n            .fill(this.props.switchColor)\n            .corners(TOGGLE_CORNER_RADIUS, TOGGLE_CORNER_RADIUS);\n\n        // Draw the left option\n        this.leftElement = this.root.group();\n        this.leftText = mkText(this.props.leftText)\n            .appendClass(\"sprite-editor-text\")\n            .fill(this.props.selectedTextColor);\n        this.leftElement.appendChild(this.leftText);\n\n        // Draw the right option\n        this.rightElement = this.root.group();\n        this.rightText = mkText(this.props.rightText)\n            .appendClass(\"sprite-editor-text\")\n            .fill(this.props.unselectedTextColor);\n        this.rightElement.appendChild(this.rightText);\n\n        this.root.onClick(() => this.toggle());\n    }\n\n    toggle(quiet = false) {\n        if (this.isLeft) {\n            this.switch.removeClass(\"toggle-left\");\n            this.switch.appendClass(\"toggle-right\");\n            this.leftText.fill(this.props.unselectedTextColor);\n            this.rightText.fill(this.props.selectedTextColor);\n        }\n        else {\n            this.switch.removeClass(\"toggle-right\");\n            this.switch.appendClass(\"toggle-left\");\n            this.leftText.fill(this.props.selectedTextColor);\n            this.rightText.fill(this.props.unselectedTextColor);\n        }\n        this.isLeft = !this.isLeft;\n\n        if (!quiet && this.changeHandler) {\n            this.changeHandler(this.isLeft);\n        }\n    }\n\n    onStateChange(handler: (left: boolean) => void) {\n        this.changeHandler = handler;\n    }\n\n    layout() {\n        const centerOffset = (TOGGLE_WIDTH - TOGGLE_BORDER_WIDTH * 2) / 4;\n        this.leftText.moveTo(centerOffset + TOGGLE_BORDER_WIDTH, TOGGLE_HEIGHT / 2);\n        this.rightText.moveTo(TOGGLE_WIDTH - TOGGLE_BORDER_WIDTH - centerOffset, TOGGLE_HEIGHT / 2)\n    }\n\n    translate(x: number, y: number) {\n        this.root.translate(x, y);\n    }\n\n    height() {\n        return TOGGLE_HEIGHT;\n    }\n\n    width() {\n        return TOGGLE_WIDTH;\n    }\n}\n\nexport class Button {\n    cx: number;\n    cy: number;\n    root: svg.Group;\n    clickHandler: () => void;\n    private _title: string;\n    private _shortcut: string;\n\n    constructor(root: svg.Group, cx: number, cy: number) {\n        this.root = root;\n        this.cx = cx;\n        this.cy = cy;\n        this.root.onClick(() => this.clickHandler && this.clickHandler());\n        this.root.appendClass(\"sprite-editor-button\");\n    }\n\n    public getElement() {\n        return this.root;\n    }\n\n    public addClass(className: string) {\n        this.root.appendClass(className);\n    }\n\n    public removeClass(className: string) {\n        this.root.removeClass(className);\n    }\n\n    public onClick(clickHandler: () => void) {\n        this.clickHandler = clickHandler;\n    }\n\n    public translate(x: number, y: number) {\n        this.root.translate(x, y);\n    }\n\n    public title(text: string) {\n        this._title = text;\n        this.setRootTitle();\n    }\n\n    public shortcut(text: string) {\n        this._shortcut = text;\n        this.setRootTitle();\n    }\n\n    private setRootTitle() {\n        this.root.title(this._title + (this._shortcut ? \" (\" + this._shortcut + \")\" : \"\"));\n    }\n\n    public setDisabled(disabled: boolean) {\n        this.editClass(\"disabled\", disabled);\n    }\n\n    public setSelected(selected: boolean) {\n        this.editClass(\"selected\", selected);\n    }\n\n    protected layout() { /* subclass */ }\n\n    protected editClass(className: string, add: boolean) {\n        if (add) {\n            this.root.appendClass(className);\n        }\n        else {\n            this.root.removeClass(className);\n        }\n    }\n}\n\nexport class TextButton extends Button {\n    protected textEl: svg.Text;\n\n    constructor(button: ButtonGroup, text: string, className: string) {\n        super(button.root, button.cx, button.cy);\n\n        this.textEl = mkText(text)\n            .appendClass(className);\n\n        this.textEl.moveTo(this.cx, this.cy);\n\n        this.root.appendChild(this.textEl);\n    }\n\n    setText(text: string) {\n        this.textEl.text(text);\n        this.textEl.moveTo(this.cx, this.cy);\n    }\n\n    getComputedTextLength() {\n        try {\n            return this.textEl.el.getComputedTextLength();\n        }\n        catch (e) {\n            // Internet Explorer and Microsoft Edge throw if the element\n            // is not visible. The best we can do is approximate\n            return this.textEl.el.textContent.length * 8;\n        }\n    }\n}\n\nexport class StandaloneTextButton extends TextButton {\n    protected padding = 30;\n\n    constructor(text: string, readonly height: number) {\n        super(drawSingleButton(65, height), text, \"sprite-editor-text\");\n        this.addClass(\"sprite-editor-label\");\n    }\n\n    layout() {\n        const newBG = drawSingleButton(this.width(), this.height);\n\n        while (this.root.el.hasChildNodes()) {\n            this.root.el.removeChild(this.root.el.firstChild);\n        }\n\n        while (newBG.root.el.hasChildNodes()) {\n            const el = newBG.root.el.firstChild;\n            newBG.root.el.removeChild(el);\n            this.root.el.appendChild(el);\n        }\n\n        this.cx = newBG.cx;\n        this.cy = newBG.cy;\n\n        this.root.appendChild(this.textEl);\n        this.textEl.moveTo(this.cx, this.cy);\n    }\n\n    width() {\n        return this.getComputedTextLength() + this.padding * 2;\n    }\n}\n\nexport class CursorButton extends Button {\n    constructor(root: svg.Group, cx: number, cy: number, width: number) {\n        super(root, cx, cy);\n\n        this.root.draw(\"rect\")\n            .fill(\"white\")\n            .size(width, width)\n            .at(Math.floor(this.cx - width / 2), Math.floor(this.cy - width / 2))\n    }\n}\n\nexport function mkIconButton(icon: string, width: number, height = width + BUTTON_BOTTOM_BORDER_WIDTH - BUTTON_BORDER_WIDTH) {\n    const g = drawSingleButton(width, height);\n    return new TextButton(g, icon, \"sprite-editor-icon\");\n}\n\nexport function mkXIconButton(icon: string, width: number, height = width + BUTTON_BOTTOM_BORDER_WIDTH - BUTTON_BORDER_WIDTH) {\n    const g = drawSingleButton(width, height);\n    return new TextButton(g, icon, \"sprite-editor-xicon\");\n}\n\nexport function mkTextButton(text: string, width: number, height: number) {\n    const g = drawSingleButton(width, height);\n    const t = new TextButton(g, text, \"sprite-editor-text\");\n    t.addClass(\"sprite-editor-label\");\n    return t;\n}\n\n/**\n * Draws a button suitable for the left end of a button group.\n *\n * @param width The total width of the result (including border)\n * @param height The total height of the resul (including border and lip)\n * @param lip  The width of the bottom border\n * @param border The width of the outer border (except bottom)\n * @param r The corner radius\n */\nfunction drawLeftButton(width: number, height: number, lip: number, border: number, r: number): ButtonGroup {\n    const root = new svg.Group().appendClass(\"sprite-editor-button\");\n    const bg = root.draw(\"path\")\n        .appendClass(\"sprite-editor-button-bg\");\n    bg.d.moveTo(r, 0)\n        .lineBy(width - r, 0)\n        .lineBy(0, height)\n        .lineBy(-(width - r), 0)\n        .arcBy(r, r, 0, false, true, -r, -r)\n        .lineBy(0, -(height - (r << 1)))\n        .arcBy(r, r, 0, false, true, r, -r)\n        .close();\n    bg.update();\n\n    const fg = root.draw(\"path\")\n        .appendClass(\"sprite-editor-button-fg\");\n    fg.d.moveTo(border + r, border)\n        .lineBy(width - border - r, 0)\n        .lineBy(0, height - lip - border)\n        .lineBy(-(width - border - r), 0)\n        .arcBy(r, r, 0, false, true, -r, -r)\n        .lineBy(0, -(height - lip - border - (r << 1)))\n        .arcBy(r, r, 0, false, true, r, -r)\n        .close();\n    fg.update();\n\n    return {\n        root,\n        cx: border + (width - border) / 2,\n        cy: border + (height - lip) / 2\n    };\n}\n\nexport class CursorMultiButton {\n    root: svg.Group;\n    selected: number;\n    buttons: Button[];\n\n    indexHandler: (index: number) => void;\n\n    constructor(parent: svg.Group, width: number) {\n        this.root = parent.group();\n        const widths = [4, 7, 10]\n\n        this.buttons = buttonGroup(65, 21, 3).map((b, i) => new CursorButton(b.root, b.cx, b.cy, widths[i]));\n        this.buttons.forEach((button, index) => {\n            button.onClick(() => this.handleClick(index));\n            button.title(sizeAdjective(index));\n            this.root.appendChild(button.getElement());\n        });\n    }\n\n    protected handleClick(index: number) {\n        if (index === this.selected) return;\n\n        if (this.selected != undefined) {\n            this.buttons[this.selected].setSelected(false);\n        }\n\n        this.selected = index;\n\n        if (this.selected != undefined) {\n            this.buttons[this.selected].setSelected(true);\n        }\n\n        if (this.indexHandler) this.indexHandler(index);\n    }\n\n    onSelected(cb: (index: number) => void) {\n        this.indexHandler = cb;\n    }\n}\n\nexport interface UndoRedoHost {\n    undo(): void;\n    redo(): void;\n}\n\nexport class UndoRedoGroup {\n    root: svg.Group;\n    undo: TextButton;\n    redo: TextButton;\n\n    host: UndoRedoHost;\n\n    constructor(parent: svg.Group, host: UndoRedoHost, width: number, height: number) {\n        this.root = parent.group();\n        this.host = host;\n        const [undo, redo] = buttonGroup(width, height, 2);\n\n        this.undo = new TextButton(undo, \"\\uf118\", \"sprite-editor-xicon\");\n        this.undo.onClick(() => this.host.undo());\n        this.root.appendChild(this.undo.getElement());\n\n\n        this.redo = new TextButton(redo, \"\\uf111\", \"sprite-editor-xicon\");\n        this.redo.onClick(() => this.host.redo());\n        this.root.appendChild(this.redo.getElement());\n    }\n\n    translate(x: number, y: number) {\n        this.root.translate(x, y);\n    }\n\n    updateState(undo: boolean, redo: boolean) {\n        this.undo.setDisabled(undo);\n        this.redo.setDisabled(redo);\n    }\n}\n\n\nfunction defaultColors(props: Partial<ToggleProps>): ToggleProps {\n    if (!props.baseColor) props.baseColor = \"#e95153\";\n    if (!props.backgroundColor) props.backgroundColor = \"rgba(52,73,94,.2)\";\n    if (!props.borderColor) props.borderColor = \"rgba(52,73,94,.4)\";\n    if (!props.selectedTextColor) props.selectedTextColor = props.baseColor;\n    if (!props.unselectedTextColor) props.unselectedTextColor = \"hsla(0,0%,100%,.9)\";\n    if (!props.switchColor) props.switchColor = \"#ffffff\";\n\n    return props as ToggleProps;\n}\n\nfunction sizeAdjective(cursorIndex: number) {\n    switch (cursorIndex) {\n        case 0: return \"Small Cursor\";\n        case 1: return \"Medium Cursor\";\n        case 2: return \"Large Cursor\";\n    }\n\n    return undefined;\n}\n\n/**\n* Draws a button suitable for the interior of a button group.\n*\n* @param width The total width of the result (including border)\n* @param height The total height of the resul (including border and lip)\n* @param lip  The width of the bottom border\n* @param border The width of the outer border (except bottom)\n*/\nfunction drawMidButton(width: number, height: number, lip: number, border: number): ButtonGroup {\n    const root = new svg.Group().appendClass(\"sprite-editor-button\");\n    const bg = root.draw(\"rect\")\n        .appendClass(\"sprite-editor-button-bg\")\n        .size(width, height)\n\n    const fg = root.draw(\"rect\")\n        .appendClass(\"sprite-editor-button-fg\")\n        .size(width - border, height - lip - border)\n        .at(border, border);\n\n    return {\n        root,\n        cx: border + (width - border) / 2,\n        cy: border + (height - lip) / 2\n    };\n}\n\n/**\n * Draws a button suitable for the right end of a button group.\n *\n * @param width The total width of the result (including border)\n * @param height The total height of the resul (including border and lip)\n * @param lip  The width of the bottom border\n * @param border The width of the outer border (except bottom)\n * @param r The corner radius\n */\nfunction drawRightButton(width: number, height: number, lip: number, border: number, r: number): ButtonGroup {\n    const root = new svg.Group().appendClass(\"sprite-editor-button\");\n    const bg = root.draw(\"path\")\n        .appendClass(\"sprite-editor-button-bg\");\n    bg.d.moveTo(0, 0)\n        .lineBy(width - r, 0)\n        .arcBy(r, r, 0, false, true, r, r)\n        .lineBy(0, height - (r << 1))\n        .arcBy(r, r, 0, false, true, -r, r)\n        .lineBy(-(width - r), 0)\n        .lineBy(0, -height)\n        .close();\n    bg.update();\n\n    const fg = root.draw(\"path\")\n        .appendClass(\"sprite-editor-button-fg\");\n    fg.d.moveTo(border, border)\n        .lineBy(width - border - r, 0)\n        .arcBy(r, r, 0, false, true, r, r)\n        .lineBy(0, height - border - lip - (r << 1))\n        .arcBy(r, r, 0, false, true, -r, r)\n        .lineBy(-(width - border - r), 0)\n        .lineBy(0, -(height - border - lip))\n        .close();\n    fg.update();\n\n    const content = root.group().id(\"sprite-editor-button-content\");\n    content.translate(border + (width - (border << 1)) >> 1, (height - lip - border) >> 1);\n\n    return {\n        root,\n        cx: width / 2,\n        cy: border + (height - lip) / 2\n    };\n}\n\n/**\n * Draws a standalone button.\n *\n * @param width The total width of the result (including border)\n * @param height The total height of the resul (including border and lip)\n * @param lip  The width of the bottom border\n * @param border The width of the outer border (except bottom)\n * @param r The corner radius\n */\nfunction drawSingleButton(width: number, height: number, lip = BUTTON_BOTTOM_BORDER_WIDTH, border = BUTTON_BORDER_WIDTH, r = BUTTON_CORNER_RADIUS): ButtonGroup {\n    const root = new svg.Group().appendClass(\"sprite-editor-button\");\n    root.draw(\"rect\")\n        .size(width, height)\n        .corners(r, r)\n        .appendClass(\"sprite-editor-button-bg\");\n\n    root.draw(\"rect\")\n        .at(border, border)\n        .size(width - (border << 1), height - lip - border)\n        .corners(r, r)\n        .appendClass(\"sprite-editor-button-fg\");\n\n    return {\n        root,\n        cx: width / 2,\n        cy: border + (height - lip) / 2\n    };\n}\n\nfunction buttonGroup(width: number, height: number, segments: number, lip = BUTTON_BOTTOM_BORDER_WIDTH, border = BUTTON_BORDER_WIDTH, r = BUTTON_CORNER_RADIUS): ButtonGroup[] {\n    const available = width - (segments + 1) * border;\n    const segmentWidth = Math.floor(available / segments);\n\n    const result: ButtonGroup[] = [];\n    for (let i = 0; i < segments; i++) {\n        if (i === 0) {\n            result.push(drawLeftButton(segmentWidth + border, height, lip, border, r));\n        }\n        else if (i === segments - 1) {\n            const b = drawRightButton(segmentWidth + (border << 1), height, lip, border, r);\n            b.root.translate((border + segmentWidth) * i, 0);\n            result.push(b);\n        }\n        else {\n            const b = drawMidButton(segmentWidth + border, height, lip, border);\n            b.root.translate((border + segmentWidth) * i, 0);\n            result.push(b);\n        }\n    }\n\n    return result;\n}\n\nexport function mkText(text: string) {\n    return new svg.Text(text)\n        .anchor(\"middle\")\n        .setAttribute(\"dominant-baseline\", \"middle\")\n        .setAttribute(\"dy\", (false /*IE or edge*/) ? \"0.3em\" : \"0.1em\")\n}","import { PaintTool, getPaintToolShortcut } from \"./tools\";\nimport {\n    Button, CursorMultiButton,\n    mkXIconButton, mkIconButton, UndoRedoGroup, UndoRedoHost\n} from \"./buttons\";\nimport * as svg from './svgUtil'\n\nexport interface SideBarHost {\n    setActiveTool(tool: PaintTool): void;\n    setActiveColor(color: number): void;\n    setToolWidth(width: number): void;\n    setIconsToDefault(): void;\n}\n\nconst TOOLBAR_WIDTH = 65;\nconst INNER_BUTTON_MARGIN = 3;\nconst PALETTE_BORDER_WIDTH = 1;\nconst BUTTON_GROUP_SPACING = 3;\nconst SELECTED_BORDER_WIDTH = 2;\nconst COLOR_PREVIEW_HEIGHT = 30;\nconst COLOR_MARGIN = 7;\n\nconst UNDO_REDO_START = 430;\nconst UNDO_REDO_WIDTH = 65;\nconst UNDO_REDO_HEIGHT = 31;\n\nconst TOOL_BUTTON_WIDTH = (TOOLBAR_WIDTH - INNER_BUTTON_MARGIN) / 2;\nconst PALLETTE_SWATCH_WIDTH = (TOOLBAR_WIDTH - PALETTE_BORDER_WIDTH * 3) / 2;\nconst TOOL_BUTTON_TOP = TOOLBAR_WIDTH / 3 + BUTTON_GROUP_SPACING;\nconst PALETTE_TOP = TOOL_BUTTON_TOP + TOOL_BUTTON_WIDTH * 3 + INNER_BUTTON_MARGIN + COLOR_MARGIN;\n\nexport class SideBar {\n    root: svg.Group;\n    host: SideBarHost;\n    palette: string[];\n\n    protected colorSwatches: svg.Rect[];\n    protected pencilTool: Button;\n    protected eraseTool: Button;\n    protected rectangleTool: Button;\n    protected fillTool: Button;\n    protected marqueeTool: Button;\n\n    protected sizeGroup: svg.Group;\n    protected buttonGroup: svg.Group;\n    protected paletteGroup: svg.Group;\n\n    protected selectedTool: Button;\n    protected selectedSwatch: svg.Rect;\n    protected colorPreview: svg.Rect;\n\n    public undoRedo: UndoRedoGroup;\n\n    constructor(palette: string[], host: SideBarHost & UndoRedoHost, parent: svg.Group) {\n        this.palette = palette;\n        this.host = host;\n        this.root = parent.group().id(\"sprite-editor-sidebar\");\n\n        this.undoRedo = new UndoRedoGroup(this.root, host, UNDO_REDO_WIDTH, UNDO_REDO_HEIGHT);\n\n        this.initSizes();\n        this.initTools();\n        this.initPalette();\n    }\n\n    updateUndoRedo(undo: boolean, redo: boolean) {\n        this.undoRedo.updateState(undo, redo);\n    }\n\n    public setTool(tool: PaintTool) {\n        this.host.setActiveTool(tool);\n\n        if (this.selectedTool) {\n            this.selectedTool.removeClass(\"selected\");\n        }\n\n        this.selectedTool = this.getButtonForTool(tool);\n\n        if (this.selectedTool) {\n            this.selectedTool.addClass(\"selected\");\n        }\n    }\n\n    public setColor(color: number) {\n        this.host.setActiveColor(color);\n\n        if (this.selectedSwatch) {\n            this.selectedSwatch.stroke(\"none\");\n        }\n\n        this.selectedSwatch = this.colorSwatches[color];\n\n        if (this.selectedSwatch) {\n            // Border is multiplied by 2 and the excess is clipped away\n            this.selectedSwatch.stroke(\"orange\", SELECTED_BORDER_WIDTH * 2);\n            this.colorPreview.fill(this.palette[color]);\n        }\n\n        // FIXME: Switch the tool to pencil\n    }\n\n    public setCursorSize(size: number) {\n        this.host.setToolWidth(size);\n    }\n\n    public setWidth(width: number) {\n        this.root.scale(width / TOOLBAR_WIDTH);\n    }\n\n    public translate(left: number, top: number) {\n        this.root.translate(left, top);\n    }\n\n    protected initSizes() {\n        this.sizeGroup = this.root.group().id(\"sprite-editor-cursor-buttons\");\n        const buttonGroup = new CursorMultiButton(this.sizeGroup, TOOLBAR_WIDTH);\n        buttonGroup.onSelected(index => {\n            this.setCursorSize(1 + (index * 2));\n        });\n        // Sets the first button to show as selected\n        buttonGroup.selected = 0;\n        buttonGroup.buttons[0].setSelected(true);\n    }\n\n    protected initTools() {\n        this.buttonGroup = this.root.group()\n            .id(\"sprite-editor-tools\")\n            .translate(0, TOOL_BUTTON_TOP);\n\n        this.pencilTool = this.initButton((\"Pencil\"), \"\\uf0b2\", PaintTool.Normal);\n\n        this.eraseTool = this.initButton((\"Erase\"), \"\\uf12d\", PaintTool.Erase);\n        this.eraseTool.translate(1 + TOOL_BUTTON_WIDTH + INNER_BUTTON_MARGIN, 0);\n\n        this.fillTool = this.initButton((\"Fill\"), \"\\uf102\", PaintTool.Fill, true);\n        this.fillTool.translate(0, TOOL_BUTTON_WIDTH + INNER_BUTTON_MARGIN);\n\n        this.rectangleTool = this.initButton((\"Rectangle\"), \"\\uf096\", PaintTool.Rectangle);\n        this.rectangleTool.translate(1 + TOOL_BUTTON_WIDTH + INNER_BUTTON_MARGIN, TOOL_BUTTON_WIDTH + INNER_BUTTON_MARGIN);\n\n        this.marqueeTool = this.initButton((\"Marquee\"), \"\\uf113\", PaintTool.Marquee, true);\n        this.marqueeTool.translate(0, (TOOL_BUTTON_WIDTH + INNER_BUTTON_MARGIN) << 1);\n\n        this.setTool(PaintTool.Normal);\n        this.undoRedo.translate(0, UNDO_REDO_START);\n    }\n\n    protected initPalette() {\n        this.paletteGroup = this.root.group().id(\"sprite-editor-palette\")\n            .translate(0, PALETTE_TOP);\n\n        // Draw the background/borders for the entire palette\n        const bgHeight = COLOR_PREVIEW_HEIGHT + PALETTE_BORDER_WIDTH * 2;\n        this.paletteGroup.draw(\"rect\")\n            .fill(\"#000000\")\n            .size(TOOLBAR_WIDTH, bgHeight);\n\n        this.paletteGroup.draw(\"rect\")\n            .fill(\"#000000\")\n            .at(0, bgHeight + COLOR_MARGIN)\n            .size(TOOLBAR_WIDTH, PALETTE_BORDER_WIDTH + (this.palette.length >> 1) * (PALLETTE_SWATCH_WIDTH + PALETTE_BORDER_WIDTH));\n\n        // The highlighted swatch has an inner border. The only way to do that in SVG\n        // is to set the stroke to double the border width and clip the excess away\n        const clip = this.paletteGroup.def().create(\"clipPath\", \"sprite-editor-selected-color\")\n            .clipPathUnits(true);\n\n        clip.draw(\"rect\")\n            .at(0, 0)\n            .size(1, 1);\n\n        // Draw a preview of the current color\n        this.colorPreview = this.paletteGroup.draw(\"rect\")\n            .at(PALETTE_BORDER_WIDTH, PALETTE_BORDER_WIDTH)\n            .size(TOOLBAR_WIDTH - PALETTE_BORDER_WIDTH * 2, COLOR_PREVIEW_HEIGHT);\n\n        // Draw the swatches for each color\n        this.colorSwatches = []\n        for (let i = 0; i < this.palette.length; i++) {\n            const col = i % 2;\n            const row = Math.floor(i / 2);\n\n            const swatch = this.paletteGroup\n                .draw(\"rect\")\n                .size(PALLETTE_SWATCH_WIDTH, PALLETTE_SWATCH_WIDTH)\n                .at(col ? PALETTE_BORDER_WIDTH * 2 + PALLETTE_SWATCH_WIDTH : PALETTE_BORDER_WIDTH, bgHeight + COLOR_MARGIN + PALETTE_BORDER_WIDTH + row * (PALETTE_BORDER_WIDTH + PALLETTE_SWATCH_WIDTH))\n                .fill(this.palette[i])\n                .clipPath(\"url(#sprite-editor-selected-color)\")\n                .onClick(() => this.setColor(i));\n            swatch.title(`${i}`)\n\n            this.colorSwatches.push(swatch);\n        }\n\n        this.setColor(0);\n    }\n\n    protected initButton(title: string, icon: string, tool: PaintTool, xicon = false) {\n        const btn = xicon ? mkXIconButton(icon, TOOL_BUTTON_WIDTH) : mkIconButton(icon, TOOL_BUTTON_WIDTH);\n        const shortcut = getPaintToolShortcut(tool);\n        if (shortcut) btn.shortcut(shortcut);\n        btn.title(title);\n\n        btn.onClick(() => {\n            this.host.setIconsToDefault();\n            this.setTool(tool);\n        });\n        this.buttonGroup.appendChild(btn.getElement());\n        return btn;\n    }\n\n    getButtonForTool(tool: PaintTool) {\n        switch (tool) {\n            case PaintTool.Normal:\n            case PaintTool.Line: return this.pencilTool;\n            case PaintTool.Erase: return this.eraseTool;\n            case PaintTool.Fill: return this.fillTool;\n            case PaintTool.Rectangle:\n            case PaintTool.Circle: return this.rectangleTool;\n            case PaintTool.Marquee: return this.marqueeTool;\n            default: return undefined;\n        }\n    }\n}","import { CanvasState } from './canvasState'\nimport { Edit } from './tools'\nimport * as utils from './util'\n\nconst alphaCellWidth = 5;\nconst dropdownPaddding = 4;\nconst lightModeBackground = \"#dedede\";\n\nexport class CanvasGrid {\n    protected cellWidth: number = 16;\n    protected cellHeight: number = 16;\n\n    private gesture: GestureState;\n    private context: CanvasRenderingContext2D;\n    private fadeAnimation: Fade;\n    private selectAnimation: number;\n\n    protected backgroundLayer: HTMLCanvasElement;\n    protected paintLayer: HTMLCanvasElement;\n    protected overlayLayer: HTMLCanvasElement;\n\n    mouseCol: number;\n    mouseRow: number;\n\n    scale: number;\n\n    constructor(protected palette: string[], public state: CanvasState, protected lightMode = false, scale: number) {\n        this.scale = scale;\n        this.paintLayer = document.createElement(\"canvas\");\n        this.paintLayer.setAttribute(\"class\", \"sprite-editor-canvas\");\n        this.overlayLayer = document.createElement(\"canvas\")\n        this.overlayLayer.setAttribute(\"class\", \"sprite-editor-canvas\")\n\n        if (!this.lightMode) {\n            this.backgroundLayer = document.createElement(\"canvas\");\n            this.backgroundLayer.setAttribute(\"class\", \"sprite-editor-canvas\")\n            this.context = this.paintLayer.getContext(\"2d\");\n        }\n        else {\n            this.context = this.paintLayer.getContext(\"2d\", { alpha: false });\n            this.context.fillStyle = lightModeBackground;\n            this.context.fill();\n        }\n\n        this.hideOverlay();\n    }\n\n\n    get image() {\n        return this.state.image;\n    }\n\n    setEyedropperMouse(on: boolean) {\n        /* TODO\n        const eyedropperClass = \"sprite-editor-eyedropper\";\n\n        const toApply = on ? utils.addClass : utils.removeClass;\n        toApply(this.paintLayer, eyedropperClass);\n        toApply(this.overlayLayer, eyedropperClass);\n        if (!this.lightMode) {\n            toApply(this.backgroundLayer, eyedropperClass);\n        }\n        */\n    }\n\n    repaint(): void {\n        this.clearContext(this.context);\n        this.drawImage();\n        if (this.state.floatingLayer) this.drawFloatingLayer();\n        else this.hideOverlay();\n    }\n\n    applyEdit(edit: Edit, cursorCol: number, cursorRow: number, gestureEnd = false) {\n        edit.doEdit(this.state);\n        this.drawCursor(edit, cursorCol, cursorRow);\n    }\n\n    drawCursor(edit: Edit, col: number, row: number) {\n        const cursor = edit.getCursor();\n\n        if (cursor) {\n            this.repaint();\n            if (edit.showPreview) {\n                edit.drawCursor(col, row, (c, r) => {\n                    this.drawColor(c, r, edit.color);\n                });\n            }\n            this.context.strokeStyle = \"#898989\";\n            this.context.strokeRect((col + cursor.offsetX) * this.cellWidth, (row + cursor.offsetY) * this.cellHeight, cursor.width * this.cellWidth, cursor.height * this.cellHeight);\n        }\n        else if (edit.isStarted) {\n            this.repaint();\n        }\n    }\n\n    bitmap() {\n        return this.image;\n    }\n\n    outerWidth(): number {\n        return this.paintLayer.getBoundingClientRect().width;\n    }\n\n    outerHeight(): number {\n        return this.paintLayer.getBoundingClientRect().height;\n    }\n\n    writeColor(col: number, row: number, color: number) {\n        this.image.set(col, row, color);\n        this.drawColor(col, row, color);\n    }\n\n    drawColor(col: number, row: number, color: number, context = this.context, transparency = !this.lightMode) {\n        const x = col * this.cellWidth;\n        const y = row * this.cellHeight;\n\n        if (color) {\n            context.fillStyle = this.palette[color - 1];\n            context.fillRect(x, y, this.cellWidth, this.cellHeight);\n        }\n        else if (!transparency) {\n            context.fillStyle = lightModeBackground;\n            context.fillRect(x, y, this.cellWidth, this.cellHeight);\n        }\n    }\n\n    restore(state: CanvasState, repaint = false) {\n        if (state.height != this.image.height || state.width != this.image.width) {\n            this.state = state.copy();\n            this.resizeGrid(state.width, state.width * state.height);\n        }\n        else {\n            this.state = state.copy();\n        }\n\n        if (repaint) {\n            this.repaint();\n        }\n    }\n\n    showResizeOverlay(): void {\n        if (this.lightMode) return;\n\n        if (this.fadeAnimation) {\n            this.fadeAnimation.kill();\n        }\n        this.showOverlay();\n        this.stopSelectAnimation();\n\n        const w = this.overlayLayer.width;\n        const h = this.overlayLayer.height;\n        const context = this.overlayLayer.getContext(\"2d\");\n        const toastWidth = 100;\n        const toastHeight = 40;\n        const toastLeft = w / 2 - toastWidth / 2;\n        const toastTop = h / 2 - toastWidth / 4;\n\n        this.fadeAnimation = new Fade((opacity, dead) => {\n            if (dead) {\n                this.drawFloatingLayer();\n                return;\n            }\n\n            this.clearContext(context);\n            context.globalAlpha = opacity;\n            context.fillStyle = \"#898989\";\n\n            // After 32x32 the grid isn't easy to see anymore so skip it\n            if (this.image.width <= 32 && this.image.height <= 32) {\n                for (let c = 1; c < this.image.width; c++) {\n                    context.fillRect(c * this.cellWidth, 0, 1, h);\n                }\n                for (let r = 1; r < this.image.height; r++) {\n                    context.fillRect(0, r * this.cellHeight, w, 1);\n                }\n            }\n\n            context.fillRect(toastLeft, toastTop, toastWidth, toastHeight);\n            context.fillStyle = \"#ffffff\";\n            context.font = \"30px sans-serif\";\n            context.textBaseline = \"middle\";\n            context.textAlign = \"center\";\n\n            context.fillText(this.image.width.toString(), toastLeft + toastWidth / 2 - 25, toastTop + toastHeight / 2);\n            context.fillText(\"x\", toastLeft + 50, toastTop + toastHeight / 2, 10);\n            context.fillText(this.image.height.toString(), toastLeft + toastWidth / 2 + 25, toastTop + toastHeight / 2);\n        }, 750, 500);\n    }\n\n    showOverlay() {\n        this.overlayLayer.style.visibility = \"visible\";\n    }\n\n    hideOverlay() {\n        this.stopSelectAnimation();\n\n        this.overlayLayer.style.visibility = \"hidden\";\n\n        if (this.fadeAnimation) {\n            this.fadeAnimation.kill();\n        }\n    }\n\n    resizeGrid(rowLength: number, numCells: number): void {\n        this.repaint();\n    }\n\n    setCellDimensions(width: number, height: number): void {\n        this.cellWidth = width | 0;\n        this.cellHeight = height | 0;\n\n        const canvasWidth = this.cellWidth * this.image.width // * this.scale;\n        const canvasHeight = this.cellHeight * this.image.height // * this.scale;\n\n        this.paintLayer.width = canvasWidth;\n        this.paintLayer.height = canvasHeight;\n        this.overlayLayer.width = canvasWidth;\n        this.overlayLayer.height = canvasHeight;\n\n        if (!this.lightMode) {\n            this.backgroundLayer.width = canvasWidth;\n            this.backgroundLayer.height = canvasHeight;\n        }\n    }\n\n    setGridDimensions(width: number, height = width, lockAspectRatio = true): void {\n        const maxCellWidth = width / this.image.width;\n        const maxCellHeight = height / this.image.height;\n\n        if (lockAspectRatio) {\n            const aspectRatio = this.cellWidth / this.cellHeight;\n\n            if (aspectRatio >= 1) {\n                const w = Math.min(maxCellWidth, maxCellHeight * aspectRatio);\n                this.setCellDimensions(w, w * aspectRatio);\n            }\n            else {\n                const h = Math.min(maxCellHeight, maxCellWidth / aspectRatio)\n                this.setCellDimensions(h / aspectRatio, h);\n            }\n        }\n        else {\n            this.setCellDimensions(maxCellWidth, maxCellHeight);\n        }\n    }\n\n    down(handler: (col: number, row: number) => void): void {\n        this.initDragSurface();\n        this.gesture.subscribe(GestureType.Down, handler);\n    }\n\n    up(handler: (col: number, row: number) => void): void {\n        this.initDragSurface();\n        this.gesture.subscribe(GestureType.Up, handler);\n    }\n\n    drag(handler: (col: number, row: number) => void): void {\n        this.initDragSurface();\n        this.gesture.subscribe(GestureType.Drag, handler);\n    }\n\n    move(handler: (col: number, row: number) => void): void {\n        this.initDragSurface();\n        this.gesture.subscribe(GestureType.Move, handler);\n    }\n\n    leave(handler: () => void): void {\n        this.initDragSurface();\n        this.gesture.subscribe(GestureType.Leave, handler);\n    }\n\n    updateBounds(top: number, left: number, width: number, height: number) {\n        this.layoutCanvas(this.paintLayer, top, left, width, height);\n        this.layoutCanvas(this.overlayLayer, top, left, width, height);\n\n        if (!this.lightMode) {\n            this.layoutCanvas(this.backgroundLayer, top, left, width, height);\n        }\n\n        this.drawImage();\n        this.drawBackground();\n    }\n\n    render(parent: HTMLDivElement) {\n        if (!this.lightMode) {\n            parent.appendChild(this.backgroundLayer);\n        }\n\n        parent.appendChild(this.paintLayer);\n        parent.appendChild(this.overlayLayer);\n    }\n\n    removeMouseListeners() {\n        this.stopSelectAnimation();\n        if (this.fadeAnimation) this.fadeAnimation.kill();\n\n        this.endDrag();\n    }\n\n    onEditStart(col: number, row: number, edit: Edit) {\n        edit.start(col, row, this.state);\n    }\n\n    onEditEnd(col: number, row: number, edit: Edit) {\n        edit.end(col, row, this.state);\n        this.drawFloatingLayer();\n    }\n\n    protected drawImage(image = this.image, context = this.context, left = 0, top = 0, transparency = !this.lightMode) {\n        for (let c = 0; c < image.width; c++) {\n            for (let r = 0; r < image.height; r++) {\n                this.drawColor(left + c, top + r, image.get(c, r), context, transparency);\n            }\n        }\n    }\n\n    protected drawBackground() {\n        if (this.lightMode) return;\n        const context = this.backgroundLayer.getContext(\"2d\", { alpha: false });\n        const alphaCols = Math.ceil(this.paintLayer.width / alphaCellWidth);\n        const alphaRows = Math.ceil(this.paintLayer.height / alphaCellWidth);\n        context.fillStyle = \"#ffffff\";\n        context.fillRect(0, 0, this.paintLayer.width, this.paintLayer.height);\n\n        context.fillStyle = \"#dedede\";\n        for (let ac = 0; ac < alphaCols; ac++) {\n            for (let ar = 0; ar < alphaRows; ar++) {\n                if ((ac + ar) % 2) {\n                    context.fillRect(ac * alphaCellWidth, ar * alphaCellWidth, alphaCellWidth, alphaCellWidth);\n                }\n            }\n        }\n    }\n\n    /**\n     * This calls getBoundingClientRect() so don't call it in a loop!\n     */\n    protected clientEventToCell(ev: MouseEvent) {\n        const coord = clientCoord(ev);\n        const bounds = this.paintLayer.getBoundingClientRect();\n        const left = bounds.left + (window.scrollX !== null ? window.scrollX : window.pageXOffset);\n        const top = bounds.top + (window.scrollY !== null ? window.scrollY : window.pageYOffset);\n\n        this.mouseCol = Math.floor((((coord.clientX) - left) / this.cellWidth));\n        this.mouseRow = Math.floor((((coord.clientY) - top) / this.cellHeight));\n\n        return [\n            this.mouseCol,\n            this.mouseRow\n        ];\n    }\n    protected drawFloatingLayer() {\n        if (!this.state.floatingLayer) {\n            return;\n        }\n        this.drawImage(this.state.floatingLayer, this.context, this.state.layerOffsetX, this.state.layerOffsetY, true);\n\n        this.drawSelectionAnimation();\n    }\n\n    protected drawSelectionAnimation(dashOffset = 0) {\n        if (!this.state.floatingLayer) {\n            this.hideOverlay();\n            return;\n        }\n        this.showOverlay();\n        const context = this.overlayLayer.getContext(\"2d\");\n        this.clearContext(context);\n        context.globalAlpha = 1;\n        context.strokeStyle = \"#303030\";\n        context.lineWidth = 2;\n        context.setLineDash([5, 3]);\n        context.lineDashOffset = dashOffset;\n        context.strokeRect(this.state.layerOffsetX * this.cellWidth, this.state.layerOffsetY * this.cellHeight, this.state.floatingLayer.width * this.cellWidth, this.state.floatingLayer.height * this.cellHeight);\n\n\n        if (!this.lightMode && !this.selectAnimation && (!this.fadeAnimation || this.fadeAnimation.dead)) {\n            let drawLayer = () => {\n                dashOffset++\n                requestAnimationFrame(() => this.drawSelectionAnimation(dashOffset));\n            };\n\n            this.selectAnimation = window.setInterval(drawLayer, 40)\n        }\n    }\n\n    private clearContext(context: CanvasRenderingContext2D) {\n        // Paint Layer has the same dimensions as all other contexts\n        context.clearRect(0, 0, this.paintLayer.width, this.paintLayer.height);\n    }\n\n    private initDragSurface() {\n\n        if (!this.gesture) {\n            this.gesture = new GestureState();\n\n            this.bindEvents(this.paintLayer);\n            this.bindEvents(this.overlayLayer);\n\n            document.addEventListener(utils.pointerEvents.move, <EventListener>this.hoverHandler);\n        }\n\n    }\n\n    private bindEvents(surface: HTMLElement) {\n        utils.pointerEvents.down.forEach(evId => {\n            surface.addEventListener(evId, <EventListener>((ev: MouseEvent) => {\n                this.startDrag();\n                const [col, row] = this.clientEventToCell(ev);\n                this.gesture.handle(InputEvent.Down, col, row);\n            }));\n        })\n\n\n        // surface.addEventListener(\"click\", (ev: MouseEvent) => {\n        //     const [col, row] = this.clientEventToCell(ev);\n        //     this.gesture.handle(InputEvent.Down, col, row);\n        //     this.gesture.handle(InputEvent.Up, col, row);\n        // });\n    }\n\n    private upHandler = (ev: MouseEvent) => {\n        this.endDrag();\n        const [col, row] = this.clientEventToCell(ev);\n        this.gesture.handle(InputEvent.Up, col, row);\n\n        ev.stopPropagation();\n        ev.preventDefault();\n    }\n\n    private leaveHandler = (ev: MouseEvent) => {\n        this.endDrag();\n        const [col, row] = this.clientEventToCell(ev);\n        this.gesture.handle(InputEvent.Leave, col, row);\n\n        ev.stopPropagation();\n        ev.preventDefault();\n    };\n\n    private moveHandler = (ev: MouseEvent) => {\n        const [col, row] = this.clientEventToCell(ev);\n        if (col >= 0 && row >= 0 && col < this.image.width && row < this.image.height) {\n            if (ev.buttons & 1) {\n                this.gesture.handle(InputEvent.Down, col, row);\n            }\n            this.gesture.handle(InputEvent.Move, col, row);\n        }\n\n        ev.stopPropagation();\n        ev.preventDefault();\n    }\n\n    private hoverHandler = (ev: MouseEvent) => {\n        const [col, row] = this.clientEventToCell(ev);\n        if (col >= 0 && row >= 0 && col < this.image.width && row < this.image.height) {\n            this.gesture.handle(InputEvent.Move, col, row);\n            this.gesture.isHover = true;\n        }\n        else if (this.gesture.isHover) {\n            this.gesture.isHover = false;\n            this.gesture.handle(InputEvent.Leave, -1, -1);\n        }\n    }\n\n    private startDrag() {\n        document.removeEventListener(utils.pointerEvents.move, <EventListener>this.hoverHandler);\n        document.addEventListener(utils.pointerEvents.move, <EventListener>this.moveHandler);\n        document.addEventListener(utils.pointerEvents.up, <EventListener>this.upHandler);\n\n        if (utils.isTouchEnabled() && !utils.hasPointerEvents()) {\n            document.addEventListener(\"touchend\", <EventListener>this.upHandler);\n            document.addEventListener(\"touchcancel\", <EventListener>this.leaveHandler);\n        }\n        else {\n            document.addEventListener(utils.pointerEvents.leave, <EventListener>this.leaveHandler);\n        }\n\n    }\n\n    private endDrag() {\n\n        document.addEventListener(utils.pointerEvents.move, <EventListener>this.hoverHandler);\n        document.removeEventListener(utils.pointerEvents.move, <EventListener>this.moveHandler);\n        document.removeEventListener(utils.pointerEvents.up, <EventListener>this.upHandler);\n        document.removeEventListener(utils.pointerEvents.leave, <EventListener>this.leaveHandler);\n\n        if (utils.isTouchEnabled() && !utils.hasPointerEvents()) {\n            document.removeEventListener(\"touchend\", <EventListener>this.upHandler);\n            document.removeEventListener(\"touchcancel\", <EventListener>this.leaveHandler);\n        }\n        else {\n            document.removeEventListener(utils.pointerEvents.leave, <EventListener>this.leaveHandler);\n        }\n\n    }\n\n\n    private layoutCanvas(canvas: HTMLCanvasElement, top: number, left: number, width: number, height: number) {\n        canvas.style.position = \"absolute\";\n        canvas.style.top = `0px`\n        canvas.style.left = `0px`\n\n        // if (this.image.width === this.image.height) {\n        //     canvas.style.top = top + \"px\";\n        //     canvas.style.left = left + \"px\";\n        // }\n        // else if (this.image.width > this.image.height) {\n        //     canvas.style.top = (top + dropdownPaddding + (height - canvas.height) / 2) + \"px\";\n        //     canvas.style.left = left + \"px\";\n        // }\n        // else {\n        //     canvas.style.top = top + \"px\";\n        //     canvas.style.left = (left + dropdownPaddding + (width - canvas.width) / 2) + \"px\";\n        // }\n    }\n\n    private stopSelectAnimation() {\n        if (this.selectAnimation) {\n            clearInterval(this.selectAnimation);\n            this.selectAnimation = undefined;\n        }\n\n    }\n}\n\nenum InputEvent {\n    Up,\n    Down,\n    Move,\n    Leave\n}\n\nenum GestureType {\n    Up,\n    Down,\n    Move,\n    Drag,\n    Leave\n}\n\ntype GestureHandler = (col: number, row: number) => void;\n\nclass GestureState {\n    lastCol: number;\n    lastRow: number;\n\n    isDown = false;\n    isHover = false;\n\n    handlers: { [index: number]: GestureHandler } = {};\n\n    handle(event: InputEvent, col: number, row: number) {\n        switch (event) {\n            case InputEvent.Up:\n                this.update(col, row);\n                this.isDown = false;\n                this.fire(GestureType.Up);\n                break;\n            case InputEvent.Down:\n                if (!this.isDown) {\n                    this.update(col, row);\n                    this.isDown = true;\n                    this.fire(GestureType.Down);\n                }\n                break;\n            case InputEvent.Move:\n                if (col === this.lastCol && row === this.lastRow) return;\n                this.update(col, row);\n                if (this.isDown) {\n                    this.fire(GestureType.Drag);\n                }\n                else {\n                    this.fire(GestureType.Move);\n                }\n                break;\n\n            case InputEvent.Leave:\n                this.update(col, row);\n                this.isDown = false;\n                this.fire(GestureType.Leave);\n                break;\n        }\n    }\n\n    subscribe(type: GestureType, handler: GestureHandler) {\n        this.handlers[type] = handler;\n    }\n\n    protected update(col: number, row: number) {\n        this.lastCol = col;\n        this.lastRow = row;\n    }\n\n    protected fire(type: GestureType) {\n        if (this.handlers[type]) {\n            this.handlers[type](this.lastCol, this.lastRow);\n        }\n    }\n}\n\nclass Fade {\n    start: number;\n    end: number;\n    slope: number;\n    dead: boolean;\n\n    constructor(protected draw: (opacity: number, dead: boolean) => void, delay: number, duration: number) {\n        this.start = Date.now() + delay;\n        this.end = this.start + duration;\n        this.slope = 1 / duration;\n        this.dead = false;\n\n        draw(1, false);\n\n        setTimeout(() => requestAnimationFrame(() => this.frame()), delay);\n    }\n\n    frame() {\n        if (this.dead) return;\n        const now = Date.now();\n        if (now < this.end) {\n            const v = 1 - (this.slope * (now - this.start));\n            this.draw(v, false);\n            requestAnimationFrame(() => this.frame());\n        }\n        else {\n            this.kill();\n            this.draw(0, true);\n        }\n    }\n\n    kill() {\n        this.dead = true;\n    }\n}\n\nexport interface ClientCoordinates {\n    clientX: number;\n    clientY: number;\n}\n\nfunction clientCoord(ev: PointerEvent | MouseEvent | TouchEvent): ClientCoordinates {\n    if ((ev as TouchEvent).touches) {\n        const te = ev as TouchEvent;\n        if (te.touches.length) {\n            return te.touches[0];\n        }\n        return te.changedTouches[0];\n    }\n    return (ev as PointerEvent | MouseEvent);\n}","// These are the characters used to output literals (but we support aliases for some of these)\nconst hexChars = [\".\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\", \"9\", \"a\", \"b\", \"c\", \"d\", \"e\", \"f\"];\n\nexport interface Coord {\n    x: number,\n    y: number\n}\n\n/**\n * 16-color sprite\n */\nexport class Bitmap {\n    public buf: Uint8Array;\n\n    constructor(public width: number, public height: number, public x0 = 0, public y0 = 0) {\n        this.buf = new Uint8Array(Math.ceil(width * height / 2));\n    }\n\n    set(col: number, row: number, value: number) {\n        if (col < this.width && row < this.height && col >= 0 && row >= 0) {\n            const index = this.coordToIndex(col, row);\n            this.setCore(index, value);\n        }\n    }\n\n    get(col: number, row: number) {\n        if (col < this.width && row < this.height && col >= 0 && row >= 0) {\n            const index = this.coordToIndex(col, row);\n            return this.getCore(index);\n        }\n        return 0;\n    }\n\n    copy(col = 0, row = 0, width = this.width, height = this.height): Bitmap {\n        const sub = new Bitmap(width, height);\n        sub.x0 = col;\n        sub.y0 = row;\n        for (let c = 0; c < width; c++) {\n            for (let r = 0; r < height; r++) {\n                sub.set(c, r, this.get(col + c, row + r));\n            }\n        }\n        return sub;\n    }\n\n    apply(change: Bitmap, transparent = false) {\n        let current: number;\n        for (let c = 0; c < change.width; c++) {\n            for (let r = 0; r < change.height; r++) {\n                current = change.get(c, r);\n\n                if (!current && transparent) continue;\n                this.set(change.x0 + c, change.y0 + r, current);\n            }\n        }\n    }\n\n    equals(other: Bitmap) {\n        if (this.width === other.width && this.height === other.height && this.x0 === other.x0 && this.y0 === other.y0 && this.buf.length === other.buf.length) {\n            for (let i = 0; i < this.buf.length; i++) {\n                if (this.buf[i] !== other.buf[i]) return false;\n            }\n            return true;\n        }\n\n        return false;\n    }\n\n    protected coordToIndex(col: number, row: number) {\n        return col + row * this.width;\n    }\n\n    protected getCore(index: number) {\n        const cell = Math.floor(index / 2);\n        if (index % 2 === 0) {\n            return this.buf[cell] & 0xf;\n        }\n        else {\n            return (this.buf[cell] & 0xf0) >> 4;\n        }\n    }\n\n    protected setCore(index: number, value: number) {\n        const cell = Math.floor(index / 2);\n        if (index % 2 === 0) {\n            this.buf[cell] = (this.buf[cell] & 0xf0) | (value & 0xf);\n        }\n        else {\n            this.buf[cell] = (this.buf[cell] & 0x0f) | ((value & 0xf) << 4);\n        }\n    }\n}\n\nexport class Bitmask {\n    protected mask: Uint8Array;\n\n    constructor(public width: number, public height: number) {\n        this.mask = new Uint8Array(Math.ceil(width * height / 8));\n    }\n\n    set(col: number, row: number) {\n        const cellIndex = col + this.width * row;\n        const index = cellIndex >> 3;\n        const offset = cellIndex & 7;\n        this.mask[index] |= (1 << offset);\n    }\n\n    get(col: number, row: number) {\n        const cellIndex = col + this.width * row;\n        const index = cellIndex >> 3;\n        const offset = cellIndex & 7;\n        return (this.mask[index] >> offset) & 1;\n    }\n}\n\nexport function resizeBitmap(img: Bitmap, width: number, height: number) {\n    const result = new Bitmap(width, height);\n    result.apply(img);\n    return result;\n}\n\nexport function imageLiteralToBitmap(text: string, defaultPattern?: string): Bitmap {\n    // Strip the tagged template string business and the whitespace. We don't have to exhaustively\n    // replace encoded characters because the compiler will catch any disallowed characters and throw\n    // an error before the decompilation happens. 96 is backtick and 9 is tab\n    text = text.replace(/[ `]|(?:&#96;)|(?:&#9;)|(?:img)/g, \"\").trim();\n    text = text.replace(/^[\"`\\(\\)]*/, '').replace(/[\"`\\(\\)]*$/, '');\n    text = text.replace(/&#10;/g, \"\\n\");\n\n    if (!text && defaultPattern)\n        text = defaultPattern;\n\n    const rows = text.split(\"\\n\");\n\n    // We support \"ragged\" sprites so not all rows will be the same length\n    const sprite: number[][] = [];\n    let spriteWidth = 0;\n\n    for (let r = 0; r < rows.length; r++) {\n        const row = rows[r];\n        const rowValues: number[] = [];\n        for (let c = 0; c < row.length; c++) {\n            // This list comes from libs/screen/targetOverrides.ts in pxt-arcade\n            // Technically, this could change per target.\n            switch (row[c]) {\n                case \"0\": case \".\": rowValues.push(0); break;\n                case \"1\": case \"#\": rowValues.push(1); break;\n                case \"2\": case \"T\": rowValues.push(2); break;\n                case \"3\": case \"t\": rowValues.push(3); break;\n                case \"4\": case \"N\": rowValues.push(4); break;\n                case \"5\": case \"n\": rowValues.push(5); break;\n                case \"6\": case \"G\": rowValues.push(6); break;\n                case \"7\": case \"g\": rowValues.push(7); break;\n                case \"8\": rowValues.push(8); break;\n                case \"9\": rowValues.push(9); break;\n                case \"a\": case \"A\": case \"R\": rowValues.push(10); break;\n                case \"b\": case \"B\": case \"P\": rowValues.push(11); break;\n                case \"c\": case \"C\": case \"p\": rowValues.push(12); break;\n                case \"d\": case \"D\": case \"O\": rowValues.push(13); break;\n                case \"e\": case \"E\": case \"Y\": rowValues.push(14); break;\n                case \"f\": case \"F\": case \"W\": rowValues.push(15); break;\n            }\n        }\n\n        if (rowValues.length) {\n            sprite.push(rowValues);\n            spriteWidth = Math.max(spriteWidth, rowValues.length);\n        }\n    }\n\n    const spriteHeight = sprite.length;\n\n    const result = new Bitmap(spriteWidth, spriteHeight)\n\n    for (let r = 0; r < spriteHeight; r++) {\n        const row = sprite[r];\n        for (let c = 0; c < spriteWidth; c++) {\n            if (c < row.length) {\n                result.set(c, r, row[c]);\n            }\n            else {\n                result.set(c, r, 0);\n            }\n        }\n    }\n\n    return result;\n}\n\nexport function bitmapToImageLiteral(bitmap: Bitmap): string {\n    let res = \"img`\";\n\n\n    if (bitmap) {\n        for (let r = 0; r < bitmap.height; r++) {\n            res += \"\\n\"\n            for (let c = 0; c < bitmap.width; c++) {\n                res += hexChars[bitmap.get(c, r)] + \" \";\n            }\n        }\n    }\n\n    res += \"\\n\";\n    res += \"`\";\n    return res;\n}","import { Bitmap } from './bitmap'\n\nexport class CanvasState {\n    image: Bitmap;\n    floatingLayer: Bitmap;\n    layerOffsetX: number;\n    layerOffsetY: number;\n\n    constructor(bitmap?: Bitmap) {\n        this.image = bitmap;\n        this.layerOffsetX = 0;\n        this.layerOffsetY = 0;\n    }\n\n    get width() {\n        return this.image.width;\n    }\n\n    get height() {\n        return this.image.height;\n    }\n\n    copy() {\n        const res = new CanvasState();\n        res.image = this.image.copy();\n\n        if (this.floatingLayer) {\n            res.floatingLayer = this.floatingLayer.copy();\n            res.floatingLayer.x0 = this.layerOffsetX;\n            res.floatingLayer.y0 = this.layerOffsetY;\n        }\n        res.layerOffsetX = this.layerOffsetX;\n        res.layerOffsetY = this.layerOffsetY;\n\n        return res;\n    }\n\n    equals(other: CanvasState) {\n        if (!this.image.equals(other.image) || (this.floatingLayer && !other.floatingLayer) || (!this.floatingLayer && other.floatingLayer)) return false;\n\n        if (this.floatingLayer) return this.floatingLayer.equals(other.floatingLayer) && this.layerOffsetX === other.layerOffsetX && this.layerOffsetY === other.layerOffsetY;\n\n        return true;\n    }\n\n    mergeFloatingLayer() {\n        if (!this.floatingLayer) return;\n\n        this.floatingLayer.x0 = this.layerOffsetX;\n        this.floatingLayer.y0 = this.layerOffsetY;\n\n        this.image.apply(this.floatingLayer, true);\n        this.floatingLayer = undefined;\n    }\n\n    copyToLayer(left: number, top: number, width: number, height: number, cut = false) {\n        if (width === 0 || height === 0) return;\n\n        if (width < 0) {\n            left += width;\n            width = -width;\n        }\n\n        if (height < 0) {\n            top += height;\n            height = -height;\n        }\n\n        this.floatingLayer = this.image.copy(left, top, width, height);\n        this.layerOffsetX = this.floatingLayer.x0;\n        this.layerOffsetY = this.floatingLayer.y0;\n\n        if (cut) {\n            for (let c = 0; c < width; c++) {\n                for (let r = 0; r < height; r++) {\n                    this.image.set(left + c, top + r, 0);\n                }\n            }\n        }\n    }\n\n    inFloatingLayer(col: number, row: number) {\n        if (!this.floatingLayer) return false;\n\n        col = col - this.layerOffsetX;\n        row = row - this.layerOffsetY;\n\n        return col >= 0 && col < this.floatingLayer.width && row >= 0 && row < this.floatingLayer.height;\n    }\n}","import * as svg from './svgUtil'\nimport { SideBarHost, SideBar } from './sidebar';\nimport { SpriteHeaderHost, SpriteHeader } from './header';\nimport { CanvasGrid } from './canvasGrid';\nimport { ReporterBar } from './reporterBar';\nimport {\n    Edit, PaintTool, getPaintToolShortcut,\n    PaintEdit, OutlineEdit, LineEdit, CircleEdit, FillEdit, MarqueeEdit\n} from './tools';\nimport { Bitmap, resizeBitmap } from './bitmap';\nimport { CanvasState } from './canvasState';\nimport { TextButton, UndoRedoGroup } from './buttons';\n\nexport const TOTAL_HEIGHT = 465;\n\nconst PADDING = 10;\n\nconst DROP_DOWN_PADDING = 4;\n\n// Height of toolbar (the buttons above the canvas)\nexport const HEADER_HEIGHT = 0;\n\n// Spacing between the toolbar and the canvas\nconst HEADER_CANVAS_MARGIN = 10;\n\n// Height of the bar that displays editor size and info below the canvas\nconst REPORTER_BAR_HEIGHT = 31;\n\n// Spacing between the canvas and reporter bar\nconst REPORTER_BAR_CANVAS_MARGIN = 5;\n\n// Spacing between palette and paint surface\nconst SIDEBAR_CANVAS_MARGIN = 10;\n\nconst SIDEBAR_WIDTH = 65;\n\n// Total allowed height of paint surface\nconst CANVAS_HEIGHT = 500 - HEADER_HEIGHT - HEADER_CANVAS_MARGIN\n    - REPORTER_BAR_HEIGHT - REPORTER_BAR_CANVAS_MARGIN - PADDING + DROP_DOWN_PADDING * 2;\n\nconst WIDTH = PADDING + SIDEBAR_WIDTH + SIDEBAR_CANVAS_MARGIN + CANVAS_HEIGHT + PADDING - DROP_DOWN_PADDING * 2;\n\nexport class SpriteEditor implements SideBarHost, SpriteHeaderHost {\n    private group: svg.Group;\n    private toolbarRoot: svg.SVG;\n\n    private paintSurface: CanvasGrid;\n    private sidebar: SideBar;\n    private header: SpriteHeader;\n    // private bottomBar: ReporterBar;\n    // private gallery: Gallery;\n\n    private state: CanvasState;\n\n    // When changing the size, keep the old bitmap around so that we can restore it\n    private cachedState: CanvasState;\n\n    private edit: Edit;\n    private activeTool: PaintTool = PaintTool.Normal;\n    private toolWidth = 1;\n    public color = 1;\n\n    private cursorCol = 0;\n    private cursorRow = 0;\n\n    private undoStack: CanvasState[] = [];\n    private redoStack: CanvasState[] = [];\n    private undoRedo: UndoRedoGroup = undefined;\n\n    private columns: number = 16;\n    private rows: number = 16;\n    private colors: string[];\n\n    private shiftDown: boolean = false;\n    private altDown: boolean = false;\n    private mouseDown: boolean = false;\n\n    private closeHandler: () => void;\n\n    constructor(bitmap: Bitmap, blocksInfo?: {}, protected lightMode = false, public scale = 1) {\n        this.colors = [\n            \"#ffffff\",\n            \"#ff2121\",\n            \"#ff93c4\",\n            \"#ff8135\",\n            \"#fff609\",\n            \"#249ca3\",\n            \"#78dc52\",\n            \"#003fad\",\n            \"#87f2ff\",\n            \"#8e2ec4\",\n            \"#a4839f\",\n            \"#5c406c\",\n            \"#e5cdc4\",\n            \"#91463d\",\n            \"#000000\"\n        ]\n        this.columns = bitmap.width;\n        this.rows = bitmap.height;\n\n        this.state = new CanvasState(bitmap.copy())\n\n        this.toolbarRoot = new svg.SVG();\n        this.toolbarRoot.setClass(\"sprite-canvas-controls\");\n        this.group = this.toolbarRoot.group();\n        this.createDefs();\n\n        this.paintSurface = new CanvasGrid(this.colors, this.state.copy(), this.lightMode, this.scale);\n\n        this.paintSurface.drag((col, row) => {\n            this.debug(\"gesture (\" + PaintTool[this.activeTool] + \")\");\n            if (!this.altDown) {\n                this.setCell(col, row, this.color, false);\n            }\n\n            // this.bottomBar.updateCursor(col, row);\n        });\n\n        this.paintSurface.up((col, row) => {\n            this.debug(\"gesture end (\" + PaintTool[this.activeTool] + \")\");\n            if (this.altDown) {\n                const color = this.state.image.get(col, row);\n                this.sidebar.setColor(color);\n            } else {\n                this.paintSurface.onEditEnd(col, row, this.edit);\n                if (this.state.floatingLayer && !this.paintSurface.state.floatingLayer) {\n                    this.pushState(true);\n                    this.state = this.paintSurface.state.copy();\n                    this.rePaint();\n                }\n                this.commit();\n                this.shiftAction();\n            }\n\n            this.mouseDown = false;\n        });\n\n        this.paintSurface.down((col, row) => {\n            if (!this.altDown) {\n                this.setCell(col, row, this.color, false);\n            }\n            this.mouseDown = true;\n        });\n\n        this.paintSurface.move((col, row) => {\n            this.drawCursor(col, row);\n            this.shiftAction()\n            // this.bottomBar.updateCursor(col, row);\n        });\n\n        this.paintSurface.leave(() => {\n            if (this.edit) {\n                this.rePaint();\n                if (this.edit.isStarted && !this.shiftDown) {\n                    this.commit();\n                }\n            }\n            // this.bottomBar.hideCursor();\n        });\n\n        this.sidebar = new SideBar(['url(\"#alpha-background\")'].concat(this.colors), this, this.group);\n        this.sidebar.setColor(this.colors.length >= 3 ? 3 : 1); // colors omits 0\n\n        // this.header = new SpriteHeader(this);\n        // this.gallery = new Gallery(blocksInfo);\n        // this.bottomBar = new ReporterBar(this.group, this, REPORTER_BAR_HEIGHT);\n\n        this.updateUndoRedo();\n\n        // Sets canvas scale\n        this.scale = scale;\n    }\n\n    setSidebarColor(color: number) {\n        this.sidebar.setColor(color);\n    }\n\n    setCell(col: number, row: number, color: number, commit: boolean): void {\n        if (commit) {\n            this.state.image.set(col, row, color);\n            this.paintCell(col, row, color);\n        }\n        else if (this.edit) {\n            if (!this.edit.isStarted) {\n                this.paintSurface.onEditStart(col, row, this.edit);\n\n                if (this.state.floatingLayer && !this.paintSurface.state.floatingLayer) {\n                    this.pushState(true);\n                    this.state = this.paintSurface.state.copy();\n                }\n            }\n            this.edit.update(col, row);\n            this.cursorCol = col;\n            this.cursorRow = row;\n            this.paintEdit(this.edit, col, row);\n        }\n    }\n\n    render(el: HTMLDivElement): void {\n        // el.appendChild(this.header.getElement());\n        // el.appendChild(this.gallery.getElement());\n        el.appendChild(this.toolbarRoot.el);\n        this.layout();\n        this.toolbarRoot.attr({ \"width\": `${65 * this.scale}px`, \"height\": this.outerHeight() + \"px\" });\n        // this.toolbarRoot.el.style.position = \"absolute\";\n        // this.toolbarRoot.el.style.top = \"0px\";\n        // this.toolbarRoot.el.style.left = \"0px\";\n\n        let canvasHolder = document.createElement(\"div\")\n        canvasHolder.setAttribute(\"class\", \"sprite-canvas-container\")\n        el.appendChild(canvasHolder)\n        this.paintSurface.render(canvasHolder);\n    }\n\n    layout(): void {\n        if (!this.toolbarRoot) {\n            return;\n        }\n\n        this.paintSurface.setGridDimensions(CANVAS_HEIGHT * this.scale);\n\n        // The width of the palette + editor\n        const paintAreaTop = (HEADER_HEIGHT + HEADER_CANVAS_MARGIN) * this.scale;\n        const paintAreaLeft = (PADDING + SIDEBAR_WIDTH + SIDEBAR_CANVAS_MARGIN) * this.scale;\n\n        // this.sidebar.translate(PADDING * this.scale, paintAreaTop);\n        // TODO(dz): hacky scaling\n        this.paintSurface.updateBounds(paintAreaTop, paintAreaLeft, CANVAS_HEIGHT * this.scale, CANVAS_HEIGHT * this.scale);\n        // this.bottomBar.layout(\n        //     HEADER_HEIGHT + HEADER_CANVAS_MARGIN + (CANVAS_HEIGHT + REPORTER_BAR_CANVAS_MARGIN),\n        //     PADDING + SIDEBAR_WIDTH + SIDEBAR_CANVAS_MARGIN, CANVAS_HEIGHT);\n\n        // this.gallery.layout(0, HEADER_HEIGHT, TOTAL_HEIGHT - HEADER_HEIGHT);\n        // this.header.layout();\n    }\n\n    rePaint() {\n        this.commit();\n        this.paintSurface.repaint();\n    }\n\n    setActiveColor(color: number, setPalette = false) {\n        if (setPalette) {\n        }\n        else if (this.color != color) {\n            this.color = color;\n\n            // If the user is erasing, go back to pencil\n            if (this.activeTool === PaintTool.Erase) {\n                this.sidebar.setTool(PaintTool.Normal);\n            } else {\n                this.updateEdit();\n            }\n        }\n    }\n\n    setActiveTool(tool: PaintTool) {\n        if (this.activeTool != tool) {\n            this.activeTool = tool;\n            this.updateEdit()\n        }\n    }\n\n    setToolWidth(width: number) {\n        if (this.toolWidth != width) {\n            this.toolWidth = width;\n            this.updateEdit();\n        }\n    }\n\n    initializeUndoRedo(undoStack: CanvasState[], redoStack: CanvasState[]) {\n        if (undoStack) {\n            this.undoStack = undoStack;\n        }\n        if (redoStack) {\n            this.redoStack = redoStack;\n        }\n        this.updateUndoRedo();\n    }\n\n    getUndoStack() {\n        return this.undoStack.slice();\n    }\n\n    getRedoStack() {\n        return this.redoStack.slice();\n    }\n\n    undo() {\n        if (this.undoStack.length) {\n            this.debug(\"undo\");\n            const todo = this.undoStack.pop();\n            this.pushState(false);\n\n            // The current state is at the top of the stack unless the user has pressed redo, so\n            // we need to discard it\n            if (todo.equals(this.state)) {\n                this.undo();\n                return;\n            }\n            this.restore(todo);\n        }\n        this.updateUndoRedo();\n    }\n\n    redo() {\n        if (this.redoStack.length) {\n            this.debug(\"redo\");\n            const todo = this.redoStack.pop();\n            this.pushState(true);\n            this.restore(todo);\n        }\n        this.updateUndoRedo();\n    }\n\n    resize(width: number, height: number) {\n        if (!this.cachedState) {\n            this.cachedState = this.state.copy();\n            this.undoStack.push(this.cachedState)\n            this.redoStack = [];\n        }\n        this.state.image = resizeBitmap(this.cachedState.image, width, height);\n        this.afterResize(true);\n    }\n\n    setSizePresets(presets: [number, number][]) {\n        // this.bottomBar.setSizePresets(presets, this.columns, this.rows);\n    }\n\n    canvasWidth() {\n        return this.columns;\n    }\n\n    canvasHeight() {\n        return this.rows;\n    }\n\n    outerWidth() {\n        return WIDTH * this.scale;\n    }\n\n    outerHeight() {\n        return TOTAL_HEIGHT * this.scale;\n    }\n\n    bitmap() {\n        return this.state;\n    }\n\n    showGallery() {\n        /*\n        this.gallery.show((result: Bitmap, err?: string) => {\n            if (err && err !== \"cancelled\") {\n                console.error(err);\n            }\n            else if (result) {\n                this.redoStack = [];\n                this.pushState(true);\n                this.restore(new CanvasState(result));\n                this.hideGallery();\n                this.header.toggle.toggle(true);\n            }\n        });*/\n    }\n\n    hideGallery() {\n        //this.gallery.hide();\n    }\n\n    closeEditor() {\n        if (this.closeHandler) {\n            const ch = this.closeHandler;\n            this.closeHandler = undefined;\n            ch();\n        }\n        if (this.state.floatingLayer) {\n            this.state.mergeFloatingLayer();\n            this.pushState(true);\n        }\n    }\n\n    onClose(handler: () => void) {\n        this.closeHandler = handler;\n    }\n\n    switchIconTo(tool: PaintTool) {\n        if (this.activeTool === tool) return;\n\n        const btn = this.sidebar.getButtonForTool(tool) as TextButton;\n\n        switch (tool) {\n            case PaintTool.Rectangle:\n                updateIcon(btn, \"\\uf096\", (\"Rectangle\"));\n                break;\n            case PaintTool.Circle:\n                updateIcon(btn, \"\\uf10c\", (\"Circle\"));\n                break;\n            case PaintTool.Normal:\n                updateIcon(btn, \"\\uf040\", (\"Pencil\"));\n                break;\n            case PaintTool.Line:\n                updateIcon(btn, \"\\uf07e\", (\"Line\"));\n                break;\n            default:  // no alternate icon, do not change\n                return;\n        }\n\n        btn.onClick(() => {\n            if (tool != PaintTool.Circle && tool != PaintTool.Line) {\n                this.setIconsToDefault();\n                this.sidebar.setTool(tool);\n            }\n        });\n\n        function updateIcon(button: TextButton, text: string, title: string) {\n            const shortcut = getPaintToolShortcut(tool);\n\n            button.setText(text);\n            button.title(title);\n            button.shortcut(shortcut);\n        }\n    }\n\n    setIconsToDefault() {\n        this.switchIconTo(PaintTool.Rectangle);\n        this.switchIconTo(PaintTool.Normal);\n    }\n\n    private keyDown = (event: KeyboardEvent) => {\n        if (event.keyCode == 16) { // Shift\n            this.shiftDown = true;\n            this.shiftAction();\n        }\n\n        if (event.keyCode === 18) { // Alt\n            this.discardEdit();\n            this.paintSurface.setEyedropperMouse(true);\n            this.altDown = true;\n        }\n\n        if (this.state.floatingLayer) {\n            let didSomething = true;\n\n            switch (event.keyCode) {\n                case 8: // backspace\n                case 46: // delete\n                    event.preventDefault();\n                    event.stopPropagation();\n                    this.state.floatingLayer = undefined;\n                    break;\n                case 37: // Left arrow\n                    this.state.layerOffsetX--;\n                    break;\n                case 38: // Up arrow\n                    this.state.layerOffsetY--;\n                    break;\n                case 39: // Right arrow\n                    this.state.layerOffsetX++;\n                    break;\n                case 40: // Down arrow\n                    this.state.layerOffsetY++;\n                    break;\n                default:\n                    didSomething = false;\n            }\n\n            if (didSomething) {\n                this.updateEdit();\n                this.pushState(true);\n                this.paintSurface.restore(this.state, true);\n            }\n        }\n\n        const tools = [\n            PaintTool.Fill,\n            PaintTool.Normal,\n            PaintTool.Rectangle,\n            PaintTool.Erase,\n            PaintTool.Circle,\n            PaintTool.Line,\n            PaintTool.Marquee\n        ]\n\n        tools.forEach(tool => {\n            if (event.key === getPaintToolShortcut(tool)) {\n                this.setIconsToDefault();\n                this.switchIconTo(tool);\n                this.sidebar.setTool(tool);\n            }\n        });\n\n        const zeroKeyCode = 48;\n        const nineKeyCode = 57;\n\n        if (event.keyCode >= zeroKeyCode && event.keyCode <= nineKeyCode) {\n            let color = event.keyCode - zeroKeyCode;\n            if (this.shiftDown) {\n                color += 9;\n            }\n            if (color <= this.colors.length) { // colors omits 0\n                this.sidebar.setColor(color);\n            }\n        }\n    }\n\n    private keyUp = (event: KeyboardEvent) => {\n        // If not drawing a circle, switch back to Rectangle and Pencil\n        if (event.keyCode === 16) { // Shift\n            this.shiftDown = false;\n            this.clearShiftAction();\n        } else if (event.keyCode === 18) { // Alt\n            this.altDown = false;\n            this.paintSurface.setEyedropperMouse(false);\n            this.updateEdit();\n        }\n    }\n\n    private undoRedoEvent = (event: KeyboardEvent) => {\n        const controlOrMeta = event.ctrlKey || event.metaKey; // ctrl on windows, meta on mac\n        if (event.key === \"Undo\" || (controlOrMeta && event.key === \"z\")) {\n            this.undo();\n            event.preventDefault();\n            event.stopPropagation();\n        } else if (event.key === \"Redo\" || (controlOrMeta && event.key === \"y\")) {\n            this.redo();\n            event.preventDefault();\n            event.stopPropagation();\n        }\n    }\n\n    addKeyListeners() {\n        document.addEventListener(\"keydown\", this.keyDown);\n        document.addEventListener(\"keyup\", this.keyUp);\n        document.addEventListener(\"keydown\", this.undoRedoEvent, true);\n    }\n\n    removeKeyListeners() {\n        document.removeEventListener(\"keydown\", this.keyDown);\n        document.removeEventListener(\"keyup\", this.keyUp);\n        document.removeEventListener(\"keydown\", this.undoRedoEvent, true);\n        this.paintSurface.removeMouseListeners();\n    }\n\n    private afterResize(showOverlay: boolean) {\n        this.columns = this.state.width;\n        this.rows = this.state.height;\n        this.paintSurface.restore(this.state, true);\n        // this.bottomBar.updateDimensions(this.columns, this.rows);\n        this.layout();\n\n        if (showOverlay) this.paintSurface.showResizeOverlay();\n\n        // Canvas size changed and some edits rely on that (like paint)\n        this.updateEdit();\n    }\n\n    private drawCursor(col: number, row: number) {\n        if (this.edit) {\n            this.paintSurface.drawCursor(this.edit, col, row);\n        }\n    }\n\n    private paintEdit(edit: Edit, col: number, row: number, gestureEnd = false) {\n        this.paintSurface.restore(this.state);\n        this.paintSurface.applyEdit(edit, col, row, gestureEnd);\n    }\n\n    private commit() {\n        if (this.edit) {\n            if (this.cachedState) {\n                this.cachedState = undefined;\n            }\n            this.pushState(true);\n            this.paintEdit(this.edit, this.cursorCol, this.cursorRow, true);\n            this.state = this.paintSurface.state.copy();\n            this.updateEdit();\n            this.redoStack = [];\n        }\n    }\n\n    private pushState(undo: boolean) {\n        const stack = undo ? this.undoStack : this.redoStack;\n        if (stack.length && this.state.equals(stack[stack.length - 1])) {\n            // Don't push empty commits\n            return;\n        }\n\n        stack.push(this.state.copy());\n        this.updateUndoRedo();\n    }\n\n    private discardEdit() {\n        if (this.edit) {\n            this.edit = undefined;\n            this.rePaint();\n        }\n    }\n\n    private updateEdit() {\n        if (!this.altDown) {\n            this.edit = this.newEdit();\n        }\n    }\n\n    private restore(state: CanvasState) {\n        if (state.width !== this.state.width || state.height !== this.state.height) {\n            this.state = state;\n            this.afterResize(false);\n        }\n        else {\n            this.state = state.copy();\n            this.paintSurface.restore(state, true);\n        }\n    }\n\n    private updateUndoRedo() {\n        // this.bottomBar.updateUndoRedo(this.undoStack.length === 0, this.redoStack.length === 0)\n        this.sidebar.updateUndoRedo(this.undoStack.length === 0, this.redoStack.length === 0)\n    }\n\n    private paintCell(col: number, row: number, color: number) {\n        this.paintSurface.writeColor(col, row, color);\n    }\n\n    private newEdit() {\n        switch (this.activeTool) {\n            case PaintTool.Normal:\n                return new PaintEdit(this.columns, this.rows, this.color, this.toolWidth);\n            case PaintTool.Rectangle:\n                return new OutlineEdit(this.columns, this.rows, this.color, this.toolWidth);\n            case PaintTool.Outline:\n                return new OutlineEdit(this.columns, this.rows, this.color, this.toolWidth);\n            case PaintTool.Line:\n                return new LineEdit(this.columns, this.rows, this.color, this.toolWidth);\n            case PaintTool.Circle:\n                return new CircleEdit(this.columns, this.rows, this.color, this.toolWidth);\n            case PaintTool.Erase:\n                return new PaintEdit(this.columns, this.rows, 0, this.toolWidth);\n            case PaintTool.Fill:\n                return new FillEdit(this.columns, this.rows, this.color, this.toolWidth);\n            case PaintTool.Marquee:\n                return new MarqueeEdit(this.columns, this.rows, this.color, this.toolWidth);\n        }\n    }\n\n    private shiftAction() {\n        if (!this.shiftDown || this.altDown)\n            return;\n\n        switch (this.activeTool) {\n            case PaintTool.Line:\n            case PaintTool.Rectangle:\n            case PaintTool.Circle:\n                this.setCell(this.paintSurface.mouseCol, this.paintSurface.mouseRow, this.color, false);\n                break;\n        }\n    }\n\n    private clearShiftAction() {\n        if (this.mouseDown)\n            return;\n\n        switch (this.activeTool) {\n            case PaintTool.Line:\n            case PaintTool.Rectangle:\n            case PaintTool.Circle:\n                this.updateEdit();\n                this.paintSurface.restore(this.state, true);\n                break;\n        }\n    }\n\n    private debug(msg: string) {\n        // if (this.debugText) {\n        //     this.debugText.text(\"DEBUG: \" + msg);\n        // }\n    }\n\n    private createDefs() {\n        this.toolbarRoot.define(defs => {\n            const p = defs.create(\"pattern\", \"alpha-background\")\n                .size(10, 10)\n                .units(svg.PatternUnits.userSpaceOnUse);\n\n            p.draw(\"rect\")\n                .at(0, 0)\n                .size(10, 10)\n                .fill(\"white\");\n            p.draw(\"rect\")\n                .at(0, 0)\n                .size(5, 5)\n                .fill(\"#dedede\");\n            p.draw(\"rect\")\n                .at(5, 5)\n                .size(5, 5)\n                .fill(\"#dedede\");\n        })\n    }\n}","import { Bitmap, bitmapToImageLiteral, imageLiteralToBitmap } from \"./sprite-editor/bitmap\";\n\nexport function f4EncodeImg(w: number, h: number, bpp: number, getPix: (x: number, y: number) => number) {\n    let r = hex2(0xe0 | bpp) + hex2(w) + hex2(h) + \"00\"\n    let ptr = 4\n    let curr = 0\n    let shift = 0\n\n    let pushBits = (n: number) => {\n        curr |= n << shift\n        if (shift == 8 - bpp) {\n            r += hex2(curr)\n            ptr++\n            curr = 0\n            shift = 0\n        } else {\n            shift += bpp\n        }\n    }\n\n    for (let i = 0; i < w; ++i) {\n        for (let j = 0; j < h; ++j)\n            pushBits(getPix(i, j))\n        while (shift != 0)\n            pushBits(0)\n        if (bpp > 1) {\n            while (ptr & 3)\n                pushBits(0)\n        }\n    }\n\n    return r\n\n    function hex2(n: number) {\n        return (\"0\" + n.toString(16)).slice(-2)\n    }\n}\n\nexport function f4PreProcess(s: string) {\n    let matrix: number[][] = []\n    let line: number[] = []\n    let tbl: { [k: string]: number } = {}\n    let maxLen = 0\n    // attrs.groups.forEach((str, n) => {\n    //     for (let c of str) tbl[c] = n\n    // })\n    s += \"\\n\"\n    for (let i = 0; i < s.length; ++i) {\n        let c = s[i]\n        switch (c) {\n            case ' ':\n            case '\\t':\n                break\n            case '\\n':\n                if (line.length > 0) {\n                    matrix.push(line)\n                    maxLen = Math.max(line.length, maxLen)\n                    line = []\n                }\n                break\n            default:\n                let v = tbl[c] // U.lookup(tbl, c) //TODO(dz):\n                if (v == null) {\n                    //     if (attrs.groups.length == 2)\n                    // v = 1 // default anything non-zero to one\n                    //     else\n                    //         throw unhandled(node, lf(\"invalid character in image literal: '{0}'\", v), 9273)\n                }\n                line.push(v)\n                break\n        }\n    }\n\n    let bpp = 8\n    // if (attrs.groups.length <= 2) {\n    //     bpp = 1\n    // } else if (attrs.groups.length <= 16) {\n    bpp = 4 // TODO:\n    // }\n    return f4EncodeImg(maxLen, matrix.length, bpp, (x, y) => matrix[y][x] || 0)\n}\n\nexport function toNumbers(colors: string[]): number[][] {\n    const res: number[][] = [];\n    for (let i = 0; i < colors.length; i++) {\n        const color = parseColorString(colors[i]);\n        res.push([_r(color), _g(color), _b(color)]);\n    }\n    return res;\n}\n\nfunction parseColorString(color: string) {\n    if (color) {\n        if (color.length === 6) {\n            return parseInt(\"0x\" + color);\n        }\n        else if (color.length === 7) {\n            return parseInt(\"0x\" + color.substr(1));\n        }\n    }\n    return 0;\n}\n\nfunction _r(color: number) { return (color >> 16) & 0xff }\nfunction _g(color: number) { return (color >> 8) & 0xff }\nfunction _b(color: number) { return color & 0xff }\n\nconst defaultPalletColors = [\n    \"#000000\",\n    \"#ffffff\",\n    \"#ff2121\",\n    \"#ff93c4\",\n    \"#ff8135\",\n    \"#fff609\",\n    \"#249ca3\",\n    \"#78dc52\",\n    \"#003fad\",\n    \"#87f2ff\",\n    \"#8e2ec4\",\n    \"#a4839f\",\n    \"#5c406c\",\n    \"#e5cdc4\",\n    \"#91463d\",\n    \"#000000\"\n]\nexport const defaultColorArray = toNumbers(defaultPalletColors);\n\nfunction scale_color(v: number) {\n    return v * v\n}\nexport function textToBinHex(text: string): string {\n    // TODO(dz): does this behave different than a roundtrip through Bitmap?\n    return f4PreProcess(text)\n}\nexport function bitmapToBinHex(bitmap: Bitmap): string {\n    // return f4PreProcess(\n    return f4EncodeImg(bitmap.width, bitmap.height, 4, bitmap.get.bind(bitmap))\n}\nexport function bitmapToText(bmp: Bitmap): string {\n    return bitmapToImageLiteral(bmp);\n}\nexport function textToBitmap(text: string): Bitmap {\n    const bmp = imageLiteralToBitmap(text);\n\n    // Ignore invalid bitmaps\n    if (bmp && bmp.width && bmp.height) {\n        return bmp\n    } else {\n        return null;\n    }\n}\n\nexport function bitmapToCanvas(bmp: Bitmap, scale: number = 4) {\n    const colors = defaultPalletColors.slice(1)\n    // const canvas = document.createElementNS(\"http://www.w3.org/2000/svg\", \"canvas\");\n    const canvas = document.createElement(\"canvas\");\n    let width = canvas.width = bmp.width * scale;\n    let height = canvas.height = bmp.height * scale;\n\n    let cellSize = scale\n\n    // TODO: Center the image if it isn't square\n    const xOffset = 0\n    const yOffset = 0\n\n    let context: CanvasRenderingContext2D;\n    context = canvas.getContext(\"2d\");\n\n    for (let c = 0; c < bmp.width; c++) {\n        for (let r = 0; r < bmp.height; r++) {\n            const color = bmp.get(c, r);\n\n            if (color) {\n                context.fillStyle = colors[color - 1];\n                context.fillRect(xOffset + c * cellSize, yOffset + r * cellSize, cellSize, cellSize);\n            }\n        }\n    }\n\n    return canvas;\n}\nexport function bitmapToUrl(bmp: Bitmap): string {\n    return bitmapToCanvas(bmp).toDataURL();\n}\n\nexport function createPngImg(x: number, y: number, w: number, h: number, bmp?: Bitmap): SVGImageElement {\n    let img = document.createElementNS(\"http://www.w3.org/2000/svg\", \"image\")\n    img.setAttribute(\"x\", `${x}`)\n    img.setAttribute(\"y\", `${y}`)\n    img.setAttribute(\"width\", `${w}px`)\n    img.setAttribute(\"height\", `${h}px`)\n    if (bmp) {\n        updatePngImg(img, bmp)\n    }\n    return img\n}\n\nexport function updatePngImg(img: SVGImageElement, bmp: Bitmap) {\n    let imgData = bitmapToUrl(bmp)\n    img.setAttributeNS(\"http://www.w3.org/1999/xlink\", \"href\", `${imgData}`)\n}","import React from 'react';\n\nimport { Bitmap } from '../sprite-editor/bitmap';\n\nimport '../css/TabBar.css';\nimport { bitmapToUrl } from '../bitmap_helpers';\n\ninterface TabBarProps {\n    tabImages: Bitmap[],\n    tabChange: (idx: number) => void\n}\ninterface TabBarState {\n    currentTab: number\n}\n\nconst R = 10\nconst ICON_H = 64\nconst ICON_W = 64\nconst TAB_MARGIN_T = 10\nconst TAB_MARGIN_B = 20\nconst SVG_W = 541\nconst TAB_SVG_H = R * 2 + ICON_H + TAB_MARGIN_T + TAB_MARGIN_B\nconst IMG_SPACE = R * 2 + ICON_W\nconst OUT = TAB_MARGIN_T + TAB_MARGIN_B + 5\nconst TOTAL_TAB_W = R * 4 + ICON_W\n\nexport class TabBar extends React.Component<TabBarProps, TabBarState>\n{\n    public TabBarSvg: SVGSVGElement | undefined;\n\n    private TOTAL_IMG_SPACE: number;\n    private LEFT_SPACE: number;\n    private TABS_START: number;\n\n    constructor(props: TabBarProps) {\n        super(props);\n\n        this.state = {\n            currentTab: 0\n        }\n\n        this.TOTAL_IMG_SPACE = IMG_SPACE * this.props.tabImages.length\n        this.LEFT_SPACE = (SVG_W - this.TOTAL_IMG_SPACE) / 2\n        this.TABS_START = this.LEFT_SPACE - R\n    }\n\n    componentDidMount() {\n        this.TabBarSvg = this.refs[\"tab-bar-svg\"] as SVGSVGElement\n    }\n    componentWillUnmount() {\n        this.TabBarSvg = undefined\n    }\n\n    getTabPath(idx: number): string {\n        let tabW = ICON_W + R * 2\n        let tabStart = this.TABS_START + tabW * idx\n        let tabFinish = SVG_W - (tabStart + tabW)\n        let tabPath = `M -${OUT},${(TAB_SVG_H - TAB_MARGIN_B) + OUT} l 0,-${OUT} l ${OUT},0 h ${tabStart} q ${R},0 ${R},-${R} v -${ICON_H} q 0,-${R} ${R},-${R} h ${ICON_W} q ${R},0 ${R},${R} v ${ICON_H} q 0,${R} ${R},${R} h ${tabFinish} l ${OUT},0 l 0,${OUT} z`\n        return tabPath\n    }\n\n    render() {\n        const viewBox = `0 0 ${SVG_W} ${TAB_SVG_H}`\n        const tabPath = this.getTabPath(this.state.currentTab)\n        const tabImgs = this.props.tabImages\n            .map((img, i) => {\n                return {\n                    x: this.TABS_START + R + R + i * IMG_SPACE,\n                    y: TAB_MARGIN_T + R,\n                    w: ICON_W,\n                    h: ICON_H,\n                    idx: i,\n                    data: bitmapToUrl(img)\n                }\n            })\n        function clickHandler(this: TabBar, idx: number) {\n            this.setState({ currentTab: idx })\n            this.props.tabChange(idx)\n        }\n        return (\n            <div ref=\"tab-bar\" className=\"tab-bar\">\n                <svg ref=\"tab-bar-svg\" viewBox={viewBox}>\n                    <path ref=\"tab-path\" d={tabPath}>\n                    </path>\n                    {tabImgs.map(i =>\n                        <image key={i.idx} x={i.x} y={i.y}\n                            width={i.w} height={i.h}\n                            href={i.data}\n                            onClick={clickHandler.bind(this, i.idx)}></image>)}\n                </svg>\n            </div>\n        );\n    }\n}\n\nexport default TabBar;\n","export function loadAppInsights(includeCookie: any) {\n    var appInsights = (window as any).appInsights || function(config: any) {\n        // @ts-ignore\n        function i(config){t[config]=function(){var i=arguments;t.queue.push(function(){t[config].apply(t,i)})}}var t={config:config},u=document,e=window,o=\"script\",s=\"AuthenticatedUserContext\",h=\"start\",c=\"stop\",l=\"Track\",a=l+\"Event\",v=l+\"Page\",y=u.createElement(o),r,f;y.src=config.url||\"https://az416426.vo.msecnd.net/scripts/a/ai.0.js\";u.getElementsByTagName(o)[0].parentNode.appendChild(y);try{t.cookie=u.cookie}catch(p){}for(t.queue=[],t.version=\"1.0\",r=[\"Event\",\"Exception\",\"Metric\",\"PageView\",\"Trace\",\"Dependency\"];r.length;)i(\"track\"+r.pop());return i(\"set\"+s),i(\"clear\"+s),i(h+a),i(c+a),i(h+v),i(c+v),i(\"flush\"),config.disableExceptionTracking||(r=\"onerror\",i(\"_\"+r),f=e[r],e[r]=function(config,i,u,e,o){var s=f&&f(config,i,u,e,o);return s!==!0&&t[\"_\"+r](config,i,u,e,o),s}),t\n    }({\n        instrumentationKey:\"9801ed01-c40f-46ec-aa40-2a1742a9e71c\",\n        disableAjaxTracking: true,\n        overridePageViewDuration: false,\n        disableExceptionTracking: true,\n        isCookieUseDisabled: !includeCookie,\n        isStorageUseDisabled: !includeCookie,\n        url: \"https://pxt.azureedge.net/blob/dd22520c096be24e7432f5b46e8aad59711f31f0/ai.0.js\" // Hardcode docs CDN url for experiment\n    });\n    (window as any).appInsights = appInsights;\n    \n    if (!isLocalHost()) {\n        appInsights.queue.push(function () {\n            appInsights.context.addTelemetryInitializer(function (envelope: any) {\n                var telemetryItem = envelope.data.baseData;\n                telemetryItem.properties = telemetryItem.properties || {};\n                telemetryItem.properties[\"target\"] = \"arcade\";\n                telemetryItem.properties[\"cookie\"] = includeCookie;\n            });\n        });\n        appInsights.trackPageView(null, scrubUrl(window.location.toString()), {urlReferrer: scrubUrl(document.referrer.toString())});\n    }\n\n    // Scrub the key (if any) from the URL.\n    function scrubUrl(url: any) {\n        var scriptIdRegex = /(?:\\d{5}-\\d{5}-\\d{5}-\\d{5})|(?:_[0-9a-zA-Z]{12})/g;\n        return url.replace(scriptIdRegex, \"xxxxx-xxxxx-xxxxx-xxxxx\");\n    }\n}\n\nexport function tickEvent(id: string, data?: any, measures?: any) {\n    // Don't log events for localhost\n    if (!isLocalHost()) (window as any).appInsights.trackEvent(id, data, measures);\n}\n\nfunction isLocalHost(): boolean {\n    try {\n        return typeof window !== \"undefined\"\n            && /^http:\\/\\/(localhost|127\\.0\\.0\\.1):\\d+\\//.test(window.location.href)\n            && !/nolocalhost=1/.test(window.location.href);\n    } catch (e) { return false; }\n}","import React from 'react';\nimport { SpriteEditor } from '../sprite-editor/spriteEditor'\nimport * as SE from '../sprite-editor/spriteEditor'\nimport TabBar from './TabBar'\n\nimport '../css/GameModder.css';\nimport '../css/icons.css';\nimport '../css/SpriteEditor.css';\nimport { imageLiteralToBitmap, Bitmap } from '../sprite-editor/bitmap';\nimport { textToBitmap, createPngImg, updatePngImg, bitmapToBinHex, textToBinHex } from '../bitmap_helpers';\nimport { tickEvent } from '../telemetry/appinsights';\n// import { bunnyHopBinJs } from '../../public/games/bunny_hop/bunny_hop_min.js.js';\n\nexport interface GameModderProps {\n    playHandler: (binJs: string) => void;\n    changeMode: (mode: \"play\" | \"share\" | \"mod\") => void;\n}\n\nexport interface UserImage {\n    default: Bitmap,\n    data: Bitmap,\n    name: string,\n    callToAction: string,\n}\nexport interface GameModderState {\n    userImages: UserImage[]\n    currentImg: number,\n}\n\nfunction CreateEmptyImageText(w: number, h: number) {\n    let res = \"\\n\"\n    for (let i = 0; i < h; i++)\n        res += \".\".repeat(w) + \"\\n\"\n    return res\n}\nfunction GetImageTextDimensions(s: string): { w: number, h: number } {\n    s = s.trim()\n    let lns = s.split(\"\\n\")\n    let ln1 = lns[0].replace(/\\s/g, \"\")\n    return {\n        w: ln1.length,\n        h: lns.length\n    }\n}\n\n// TODO: either we need binHexToBitmap or we need the original source code\n\nfunction mkPxtJson(): string {\n    let json = {\n        \"name\": \"SampleIMages\",\n        \"dependencies\": {\n            \"device\": \"*\"\n        },\n        \"description\": \"\",\n        \"files\": [\n            \"main.blocks\",\n            \"main.ts\",\n            \"README.md\"\n        ],\n        \"preferredEditor\": \"blocksprj\"\n    }\n    return JSON.stringify(json)\n}\n\nasync function getTxtFile(url: string): Promise<string> {\n    return new Promise((resolve, reject) => {\n        var xhr = new XMLHttpRequest();\n        xhr.open('GET', url, true);\n        xhr.responseType = 'text';\n        xhr.onload = function () {\n            var status = xhr.status;\n            if (status === 200) {\n                resolve(xhr.response);\n            } else {\n                const err = new Error(`Error response (${status}) from '${url}'; content: ${xhr.response}`);\n                reject(err)\n            }\n        };\n        xhr.send();\n    });\n};\n\nconst moddableImages: { [k: string]: string } = {\n    \"character\": `\n        . . . . . . . . . . . .\n        . . . 1 1 . 1 1 . . . .\n        . . . 1 3 . 1 3 . . . .\n        . . . . 1 3 . 1 3 . . .\n        . . . . 1 3 . 1 3 . . .\n        . . . 1 1 1 1 1 1 . . .\n        . . 1 1 1 1 1 1 1 1 . .\n        . . 1 1 1 f 1 1 f 1 . .\n        . . 1 1 1 1 1 1 1 1 . .\n        . . 1 1 1 1 f f 1 1 . .\n        . . . 1 1 1 1 1 1 . . .\n        . 1 1 1 1 1 1 1 1 1 1 .\n        . 1 1 1 1 1 1 1 1 1 1 .\n        . . . . 1 1 1 1 . . . .\n        . . . . 1 1 1 1 . . . .\n        . . . . 1 1 1 1 . . . .\n        . . . . 1 1 1 1 . . . .\n        . . . . . 1 1 . . . . .\n        . . . . . . 1 . . . . .\n        . . . . . . . . . . . .\n        . . . . . . . . . . . .\n    `,\n    \"obstacle1\": `\n        . . . . . . . . . . . . . . . . . . . . . .\n        . . . . . . . . . . 7 . . . . . . . . . . .\n        . . . . . . . . . . 7 7 . . . . . . . . . .\n        . . . . . . . . . 6 7 7 . . . . . . . . . .\n        . . . . . . . . 6 6 7 7 7 . . . . . . . . .\n        . . . . . . . . 6 6 7 7 7 . . . . . . . . .\n        . . . . . . . . 6 6 7 7 7 7 . . . . . . . .\n        . . . . . . . 6 6 7 7 7 7 7 . . . . . . . .\n        . . . . . . 6 6 6 7 7 7 7 7 . . . . . . . .\n        . . . . . . . . 6 6 6 6 6 . . . . . . . . .\n        . . . . . . . . 6 6 6 6 . . . . . . . . . .\n        . . . . . . . 6 6 6 6 6 7 7 . . . . . . . .\n        . . . . . . 6 6 6 7 7 7 7 7 7 . . . . . . .\n        . . . . . . 6 6 6 7 7 7 7 7 7 7 . . . . . .\n        . . . . . . 6 6 7 7 7 7 7 7 7 7 7 . . . . .\n        . . 6 6 6 6 6 7 7 7 7 7 7 7 7 7 7 7 7 . . .\n        . . . 6 6 6 6 6 7 7 7 7 7 6 6 6 6 6 . . . .\n        . . . . . . . . 6 6 6 6 7 7 . . . . . . . .\n        . . . . . . . . 6 6 6 7 7 7 . . . . . . . .\n        . . . . . . 6 6 7 7 7 7 7 7 7 . . . . . . .\n        . . . 6 6 6 7 7 7 7 7 7 7 7 7 7 7 . . . . .\n        6 6 6 6 7 7 7 7 7 7 7 7 7 7 7 7 7 7 . . . .\n        6 6 6 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 7 6\n        . . . 6 6 6 6 6 6 7 7 7 7 7 7 7 7 7 7 7 6 .\n        . . . . . 6 6 6 6 e e e e 7 7 7 7 7 6 6 6 .\n        . . . . . . . . . e e e e . . . . . . . . .\n        . . . . . . . . . e e e e . . . . . . . . .\n        . . . . . . . . . e e e e . . . . . . . . .\n        . . . . . . . 6 . e e e e . . 6 . . . . . .\n        . . . 6 6 6 . . . e e e e . 6 . . . . . . .\n        . . . 6 . 6 . . . e e e e . . . . . . . . .\n        . . . . . . . . . . . . . . . . . . . . . .\n   `,\n    \"obstacle2\": `\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . . . . . . . . . . .\n        . . . . . e e e e e . . . . .\n        . . . . e e b b b e e . . . .\n        . . . e e b e e e b e e . . .\n        . . . e e b e e b b e e . . .\n        . . . . e e b b e e e . . . .\n        . . . e b e e e e b b e . . .\n        . . . e e b b b b e e e . . e\n        . . . e e e e e e e e . . e .\n        . . . e b e e b e b e . e . e\n        . . . e b e e e e b e e . . .\n        . . . e e e b e e e e . . . .\n        . . e e b e b e b e e e . . .\n        . e e e e e e e e e e e e . .\n        . . . . . . e e . . . . . . .\n   `,\n    \"background\": `\n   . . . . . . . . 1 1 1 1 1 1 1 1 . . . . . . . . . . . . . . . . .\n   . . . . . . . 1 1 1 1 1 1 1 1 1 1 . . . . . . . . . . . . . . . .\n   . . . . 1 1 1 1 1 1 1 1 1 1 1 1 1 1 . . . . . . . . . . . . . . .\n   . . . 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 . . . . . . . . . . . . . .\n   . . 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 . . . . . . . .\n   . . 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 . . . . . . .\n   . 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 . . . . . .\n   . 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 . . . . .\n   1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 . . . . .\n   1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 . . .\n   . 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 . .\n   . 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 .\n   . . 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1\n   . . . . . 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1\n   . . . . . . 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 . . .\n   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .\n   `\n}\nconst CALL_TO_ACTION: { [k: string]: string } = {\n    \"character\": \"Draw your character!\",\n    \"obstacle1\": \"Draw an obstacle!\",\n    \"obstacle2\": \"Draw another obstacle!\",\n    \"background\": \"Choose your background!\"\n}\n// TODO:\n// 15x32 stump\n// 22x32 tree\n\nexport class GameModder extends React.Component<GameModderProps, GameModderState> {\n    protected playBtn: HTMLButtonElement | undefined;\n    protected spriteEditorHolder: HTMLDivElement | undefined;\n    protected spriteEditor: SpriteEditor;\n    private tabImages: Bitmap[];\n\n    constructor(props: GameModderProps) {\n        super(props);\n\n        let imgs = Object.keys(moddableImages)\n            .map((name) => {\n                let def = moddableImages[name]\n                // TODO: match the original dimensions? One difficulty with this\n                // is the sprite editor canvas can't handle this\n                // let { w, h } = GetImageTextDimensions(moddableImages[name])\n                let [w, h] = [16, 16]\n                let blank = CreateEmptyImageText(w, h);\n                return {\n                    data: imageLiteralToBitmap(blank),\n                    name: name,\n                    callToAction: CALL_TO_ACTION[name],\n                    default: textToBitmap(def)\n                };\n            })\n\n        this.state = {\n            userImages: imgs,\n            currentImg: 0\n        }\n\n        this.tabImages = Object.keys(moddableImages)\n            .map(k => moddableImages[k])\n            .map(textToBitmap)\n    }\n\n    renderSpriteEditor() {\n        if (!this.spriteEditorHolder)\n            return;\n\n        // const { value } = this.props;\n        // const stateSprite = value && this.stripImageLiteralTags(value)\n\n        let body = document.getElementsByTagName('body')[0]\n        let header = this.refs['header'] as HTMLDivElement\n        // const MARGIN = 20\n        const MARGIN = 0\n        let actualWidth = body.clientWidth - MARGIN\n        let actualHeight = body.clientHeight - header.clientHeight - MARGIN\n        let refWidth = 539.0\n        let refHeight = SE.TOTAL_HEIGHT\n        let wScale = actualWidth / refWidth\n        let hScale = actualHeight / refHeight\n        let scale = Math.min(wScale, hScale)\n        console.log(`Sprite editor scale: ${scale}`)\n        let htmlEl = document.getElementsByTagName('html')[0]\n        // htmlEl.setAttribute(\"style\", `font-size: ${scale}px`)\n\n        let currImg = this.state.userImages[this.state.currentImg].data\n        this.spriteEditor = new SpriteEditor(currImg, null, false, scale);\n        this.spriteEditor.render(this.spriteEditorHolder);\n        // HACK: scaling\n        header.setAttribute(\"style\", `transform: scale(${scale})`);\n        function scaleAtt(el: Element, attName: string, scale: number) {\n            let oldW = parseInt(el.getAttribute(attName))\n            let newW = oldW * scale\n            el.setAttribute(attName, newW.toString())\n        }\n        let canvases = document.getElementsByClassName(\"sprite-editor-canvas\")\n        for (let c of canvases) {\n            // scaleAtt(c, \"width\", scale)\n            // scaleAtt(c, \"height\", scale)\n        }\n        let controls = document.getElementsByClassName(\"sprite-canvas-controls\")\n        for (let c of controls) {\n            let oldW = parseInt(c.getAttribute(\"width\").replace(\"px\", \"\"))\n            let oldH = parseInt(c.getAttribute(\"height\").replace(\"px\", \"\"))\n            // fudge of 5 for scale 1.892\n            const fudge = 0 // 5 * scale\n            let newW = (oldW - fudge) / scale\n            let newH = (oldH - fudge) / scale\n            c.setAttribute(\"viewBox\", `${fudge} ${fudge} ${newW} ${newH}`)\n        }\n        // END HACK\n\n        this.spriteEditor.rePaint();\n        this.spriteEditor.setActiveColor(1, true);\n        this.spriteEditor.setSizePresets([\n            [8, 8],\n            [16, 16],\n            [32, 32],\n            [10, 8]\n        ]);\n\n        this.spriteEditorHolder.style.height = (this.spriteEditor.outerHeight()) + \"px\";\n        this.spriteEditorHolder.style.width = (this.spriteEditor.outerWidth()) + \"px\";\n        this.spriteEditorHolder.style.overflow = \"hidden\";\n        this.spriteEditorHolder.className = 'sprite-editor-container sprite-editor-dropdown-bg sprite-editor-dropdown';\n        this.spriteEditor.addKeyListeners();\n        this.spriteEditor.onClose(() => {\n            console.log(\"Closing sprite editor!\")\n            this.onPlay()\n        });\n    }\n\n    async renderExperiments() {\n        let tabBar = this.refs[\"tab-bar\"] as TabBar\n        let dummyImg = createPngImg(20, 20, 64, 64)\n        tabBar.TabBarSvg.appendChild(dummyImg)\n        setInterval(() => {\n            updatePngImg(dummyImg, this.spriteEditor.bitmap().image)\n        }, 500)\n\n        function getImages(ts: string) {\n            let imgRegex = /img`([\\d\\s\\.a-f]*)`/gm\n            let match = imgRegex.exec(ts);\n            let res: string[] = []\n            while (match != null) {\n                res.push(match[1])\n                match = imgRegex.exec(ts);\n            }\n            return res\n        }\n\n        let mainTs = await getTxtFile(\"games/bunny_hop/main.ts\")\n        // TODO: find images\n        let imgs = getImages(mainTs)\n        // console.dir(imgs)\n\n        let imgsAsBmps = imgs.map(textToBitmap)\n        // console.dir(imgsAsBmps)\n    }\n\n    async renderGallery() {\n        // TODO: move to seperate component\n        const SVG_W = 541\n        const OUT = 40\n        const GAL_MARGIN_B = 50\n        const GAL_SVG_H = 10 + GAL_MARGIN_B\n        // const GAL_MARGIN_B = 20\n        // const GAL_SVG_H = 40\n        let galleryHolder = this.refs[\"sprite-gallery\"] as HTMLDivElement\n        let gallerySvg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\")// as unknown as SVGSVGElement;\n        let galleryEnd = document.createElementNS(\"http://www.w3.org/2000/svg\", \"path\")\n        let galleryEndPath = `M -${OUT},-${OUT} l 0,${OUT} l 0,${GAL_SVG_H - GAL_MARGIN_B} l ${OUT},0 h ${SVG_W} l ${OUT},0 l 0,-${GAL_SVG_H - GAL_MARGIN_B} l 0,-${OUT} z`\n        galleryEnd.setAttribute(\"d\", galleryEndPath)\n        gallerySvg.setAttribute('viewBox', `0 0 ${SVG_W} ${GAL_SVG_H}`)\n        gallerySvg.appendChild(galleryEnd)\n        galleryHolder.appendChild(gallerySvg)\n    }\n\n    save() {\n        function updateUserImage(old: UserImage, nw: Bitmap): UserImage {\n            tickEvent(\"shareExperiment.mod.image\");\n            return {\n                data: nw,\n                name: old.name,\n                callToAction: old.callToAction,\n                default: old.default\n            }\n        }\n        this.setState({\n            userImages: this.state.userImages.map((m, i) =>\n                i === this.state.currentImg\n                    ? updateUserImage(m, this.spriteEditor.bitmap().image) //.copy()\n                    : m)\n        })\n    }\n    load(idx: number) {\n        let currImg = this.state.userImages[idx].data\n        this.spriteEditor.bitmap().image = currImg\n        this.spriteEditor.rePaint()\n    }\n\n    onTabChange(idx: number) {\n        this.save()\n        this.setState({ currentImg: idx })\n        this.load(idx)\n        tickEvent(\"shareExperiment.mod.tabChange\");\n    }\n\n    render() {\n        let currImg = this.state.userImages[this.state.currentImg]\n        let isBackgroundTab = this.state.currentImg === 3\n        return (\n            <div className=\"game-modder\">\n                <h1 ref=\"header\">{currImg.callToAction}</h1>\n                <TabBar ref=\"tab-bar\" tabImages={this.tabImages} tabChange={this.onTabChange.bind(this)} />\n                <div ref=\"sprite-editor-holder\" className=\"sprite-editor-holder\">\n                </div>\n                <div ref=\"sprite-gallery\" className=\"sprite-gallery\">\n                </div>\n                <button ref=\"play-btn\">Play!</button>\n            </div>\n        )\n    }\n\n    async componentDidMount() {\n        this.playBtn = this.refs[\"play-btn\"] as HTMLButtonElement;\n        this.spriteEditorHolder = this.refs['sprite-editor-holder'] as HTMLDivElement;\n\n        // events\n        this.playBtn.addEventListener('click', this.onPlay.bind(this))\n\n        // TODO(dz):\n        this.renderSpriteEditor()\n        await this.renderGallery();\n        // await this.renderExperiments();\n    }\n\n    componentWillUnmount() {\n        this.playBtn = undefined;\n        this.spriteEditorHolder = undefined;\n    }\n\n    async onPlay() {\n        this.save()\n\n        function modImg(bin: string, img: UserImage) {\n            // HACK: for some reason the compiler emits image prefixes that look like:\n            // 8704100010000000\n            // whereas ours look like:\n            // e4101000\n            const MOD_PREFIX_LEN = \"e4101000\".length\n            const BIN_PREFIX_LEN = \"8704100010000000\".length\n\n            let newHex = bitmapToBinHex(img.data)\n            let newIsBlank = newHex.slice(MOD_PREFIX_LEN).replace(/0/g, \"\").length == 0\n            if (newIsBlank)\n                newHex = bitmapToBinHex(img.default)\n\n            const oldToFind = bitmapToBinHex(img.default)\n                .slice(MOD_PREFIX_LEN)\n            let oldStartIncl = bin.indexOf(oldToFind) - BIN_PREFIX_LEN\n            let oldEndExcl = bin.indexOf(`\"`, oldStartIncl)\n            let oldHex = bin.slice(oldStartIncl, oldEndExcl)\n\n            return bin.replace(oldHex, newHex)\n        }\n\n        let gameBinJs = await getTxtFile(\"games/bunny_hop/bin.js\");\n        for (let i of this.state.userImages) {\n            gameBinJs = modImg(gameBinJs, i)\n        }\n\n        this.props.playHandler(gameBinJs)\n    }\n}\n\nexport default GameModder;\n","import React from 'react';\nimport './App.css';\n\nimport GamePlayer from './components/GamePlayer';\nimport GameModder from './components/GameModder';\nimport Share from './components/Share';\nimport HeaderBar from './components/HeaderBar';\n\nimport { loadAppInsights, tickEvent } from './telemetry/appinsights';\n\ninterface AppState {\n    mode: \"mod\" | \"play\" | \"share\"\n}\n\nlet lastBinary: string;\nlet playTimestamp: number;\n\nexport class App extends React.Component<{}, AppState> {\n    constructor(props: {}) {\n        super(props)\n        this.state = {\n            mode: \"mod\"\n        }\n\n        this.playGame = this.playGame.bind(this);\n\n        loadAppInsights(false);\n        tickEvent(\"shareExperiment.landing\");\n    }\n\n    render() {\n        return (\n            <div className=\"App\">\n                {this.state.mode === \"mod\" ?\n                    <GameModder playHandler={this.playGame} changeMode={this.changeMode} /> :\n                    (\n                        this.state.mode === \"play\" ?\n                            <GamePlayer binJs={lastBinary} changeMode={this.changeMode} /> :\n                            <Share changeMode={this.changeMode} />\n                    )\n                }\n            </div>\n        );\n    }\n\n    playGame(binJs: string) {\n        lastBinary = binJs;\n        playTimestamp = Date.now();\n\n        this.setState({ mode: \"play\" })\n        tickEvent(\"shareExperiment.play\");\n    }\n\n    modGame() {\n        if (playTimestamp) {\n            // TODO ensure that time is calculated on play -> share page navigation as well\n            tickEvent(\"shareExperiment.playtime\", { \"duration\": Date.now() - playTimestamp });\n            playTimestamp = null;\n        }\n\n        this.setState({ mode: \"mod\" });\n        tickEvent(\"shareExperiment.mod\");\n    }\n\n    protected changeMode = (mode: \"play\" | \"share\" | \"mod\") => {\n        this.setState({ mode });\n    }\n}\n\nexport default App;\n","import React from 'react';\n\nimport '../css/Share.css';\nimport '../css/icons.css';\n\nconst legalText = \"You need to publish your project to share it. You acknowledge having consent to publish this project.\";\nconst testURL = \"data:image/png;base64,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\";\n\ninterface ShareProps {\n    changeMode: (mode: \"play\" | \"share\" | \"mod\") => void;\n}\n\nclass Share extends React.Component<ShareProps, {}> {\n\n    render() {\n        const { changeMode } = this.props;\n        return (\n            <div className=\"share-page\">\n                <div className=\"share-header\">\n                    <div className=\"back-arrow-button\" title=\"Mod\" role=\"button\" onClick={() => changeMode(\"mod\")}>\n                        <div className=\"back-arrow\"></div>\n                        <div className=\"back-arrow-label\">Mod</div>\n                    </div>\n                </div>\n                <h1>Share your game!</h1>\n                <div className=\"share-screenshot-container\">\n                    <img className=\"share-screenshot\" src={testURL} ></img>\n                </div>\n                <div className=\"share-legal-text\">\n                    {legalText}\n                </div>\n                <div className=\"publish-action\">\n                    <button className=\"publish-button\">Publish Project</button>\n                </div>\n            </div>\n        )\n    }\n}\n\nexport default Share;","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\n\nReactDOM.render(<App />, document.getElementById('root'));"],"sourceRoot":""}